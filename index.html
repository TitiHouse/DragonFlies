<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#D9006C"/>
    <title>Planificateur d'horaire</title>

    <style>
        /* Styles CSS */
        :root {
            /* --- Palette Rose/Fuchsia (Défaut) --- */
            --rose-principal: #D9006C;
            --rose-moyen: #FF69B4;
            --rose-clair: #FFB6C1;
            --rose-pale: #FFF0F5;
            --rose-semi-transparent: rgba(217, 0, 108, 0.1);
            --mauve-soir: #BA55D3;
            --mauve-soir-fond: rgba(186, 85, 211, 0.1);
            --body-bg-rose: #FFF5F9;

            /* --- Palette Orange --- */
            --orange-principal: #FF8C00;  /* DarkOrange */
            --orange-moyen: #FFA500;     /* Orange */
            --orange-clair: #FFDAB9;     /* PeachPuff */
            --orange-pale: #FFFACD;      /* LemonChiffon */
            --orange-semi-transparent: rgba(255, 140, 0, 0.1);
            --body-bg-orange: #FFF8DC;  /* Cornsilk */
            --vert-ok-orange: #228B22; /* ForestGreen */
            --rouge-nok-orange: #B22222; /* Firebrick */

            /* --- Palette Bleue --- */
            --bleu-p-principal: #007bff;    /* Primary Blue */
            --bleu-p-moyen: #0056b3;     /* Darker Blue */
            --bleu-p-clair: #ADD8E6;     /* LightBlue */
            --bleu-p-pale: #E0FFFF;      /* LightCyan */
            --bleu-p-semi-transparent: rgba(0, 123, 255, 0.1);
            --body-bg-bleu: #F0F8FF;      /* AliceBlue */
            --vert-ok-bleu: #198754;      /* Bootstrap Green */
            --rouge-nok-bleu: #dc3545;      /* Bootstrap Red */

            /* --- Palette Verte --- */
            --vert-p-principal: #28a745;    /* Primary Green */
            --vert-p-moyen: #198754;     /* Darker Green */
            --vert-p-clair: #90EE90;     /* LightGreen */
            --vert-p-pale: #F0FFF0;      /* Honeydew */
            --vert-p-semi-transparent: rgba(40, 167, 69, 0.1);
            --body-bg-vert: #F5FFF5;      /* MintCream */
            --vert-ok-vert: #228B22;       /* Forest Green */
            --rouge-nok-vert: #dc3545;       /* Bootstrap Red */

            /* --- Autres variables (communes ou ajustées par thème) --- */
            /* Note: --rose-principal, --rose-moyen etc. sont redéfinies par les thèmes */
            --bleu-matin: #007bff; /* Le bleu matin peut rester constant ou être ajusté */
            --bleu-matin-fond: rgba(0, 123, 255, 0.1);
            --vert-ok: #28a745; /* Défaut Rose */
            --rouge-nok: #dc3545; /* Défaut Rose */
            --gris-verif: #eee;
            --gris-bordure: #ccc;
            --gris-bordure-legere: #eee;
            --gris-neutre-bouton: #6c757d;
            --gris-neutre-bouton-hover: #5a6268;
            --drop-zone-bg: #e9f5ff;
            --dragging-opacity: 0.5;
            --blanc: #fff;
        }
        /* --- Styles Communs --- */
        body {
            font-family: Arial, sans-serif;
            color: #333;
            margin: 20px;
            padding-bottom: 80px;
            transition: background-color 0.3s ease; /* Transition douce pour le fond */
        }
        /* Style de fond par défaut (Rose) */
        body:not(.theme-orange):not(.theme-blue):not(.theme-green) {
            background-color: var(--body-bg-rose);
        }

        .container {
            max-width: 95%; margin: 0 auto; padding: 20px; background-color: white; border-radius: 8px;
            box-shadow: 0 0 15px var(--rose-semi-transparent); /* Ombre utilise la variable principale du thème actif */
            position: relative; /* Pour positionnement absolu du sélecteur thème */
        }

        h1, h2 { color: var(--rose-principal); border-bottom: 2px solid var(--rose-clair); padding-bottom: 5px; }
        hr { border: none; border-top: 3px solid var(--rose-principal); margin: 40px 0; } /* HR principaux suivent thème */
        .menu-collaborateurs hr, #menu-reset-content hr { border-top: 1px solid var(--gris-bordure-legere); margin: 10px 0; } /* HR fins restent gris */

        table { border-collapse: collapse; margin: 20px 0; box-shadow: 0 0 10px var(--rose-semi-transparent); width: 100%; background-color: white; }
        th {
            background-color: var(--rose-moyen); color: white; padding: 10px;
            text-align: center; position: sticky; top: 0; z-index: 2;
        }
        td {
            padding: 8px; background-color: white; vertical-align: middle;
            border: 1px solid var(--gris-bordure-legere);
        }

        /* --- Styles Tableaux Désidératats --- */
        #tableau-désidératats tbody tr td,
        #tableau-désidératats-soir tbody tr td { vertical-align: middle; }
        #tableau-désidératats tbody tr:nth-child(even) td,
        #tableau-désidératats-soir tbody tr:nth-child(even) td { background-color: var(--rose-pale); }

        /* Colonne 1: Compétences */
        #tableau-désidératats th:first-child, #tableau-désidératats td:first-child,
        #tableau-désidératats-soir th:first-child, #tableau-désidératats-soir td:first-child {
            min-width: 180px; width: auto; position: sticky; left: 0; background-color: inherit; z-index: 1; border-right: 1px solid var(--gris-bordure); padding: 4px; text-align: left; white-space: normal; box-sizing: border-box;
        }
        #tableau-désidératats th:first-child, #tableau-désidératats-soir th:first-child { z-index: 3; background-color: var(--rose-moyen); text-align: center; }
        #tableau-désidératats td:first-child, #tableau-désidératats-soir td:first-child { background-color: white; padding: 4px;}
        #tableau-désidératats tbody tr:nth-child(even) td:first-child, #tableau-désidératats-soir tbody tr:nth-child(even) td:first-child { background-color: var(--rose-pale); }
        .competence-label { display: inline-block; margin: 0 8px 4px 0; padding: 3px 6px; background-color: var(--rose-pale); border-radius: 3px; font-size: 11px; white-space: nowrap; cursor: pointer; transition: background-color 0.2s; line-height: 1.2; }
        .competence-label:hover { background-color: var(--rose-clair); }
        .competence-label input[type="checkbox"] { margin-right: 4px; accent-color: var(--rose-principal); cursor: pointer; transform: scale(1.1); vertical-align: middle; }
        #tableau-désidératats tbody tr:nth-child(even) td:first-child .competence-label, #tableau-désidératats-soir tbody tr:nth-child(even) td:first-child .competence-label { background-color: var(--blanc); }

        /* Colonne 2: Nom Collaborateur */
        #tableau-désidératats th:nth-child(2), #tableau-désidératats-soir th:nth-child(2) {
            min-width: 200px; text-align: left; font-weight: bold; position: sticky; left: 180px; background-color: var(--rose-moyen); z-index: 3; border-right: 1px solid var(--gris-bordure); display: flex; align-items: center; justify-content: flex-start; box-sizing: border-box; white-space: normal; padding: 2px 8px; height: 40px;
        }
        #tableau-désidératats td:nth-child(2), #tableau-désidératats-soir td:nth-child(2) {
            width: auto; min-width: 200px; text-align: left; white-space: normal; font-weight: bold; position: sticky; left: 180px; z-index: 1; border-right: 1px solid var(--gris-bordure); display: flex; align-items: center; justify-content: space-between; box-sizing: border-box; padding: 2px 8px; height: 40px;
        }
        #tableau-désidératats tbody tr:nth-child(even) td:nth-child(2), #tableau-désidératats-soir tbody tr:nth-child(even) td:nth-child(2) { background-color: var(--rose-pale); }
        .button-group-desiderata { display: inline-flex; gap: 4px; margin-left: 8px; flex-shrink: 0; }
        .btn-desiderata { padding: 2px 6px; font-size: 11px; font-weight: bold; color: white; border: none; border-radius: 3px; cursor: pointer; line-height: 1.2; min-width: 18px; text-align: center; }
        h2 span.btn-desiderata { vertical-align: middle; }
        .btn-desiderata.btn-v { background-color: var(--vert-ok); } .btn-desiderata.btn-v:hover { background-color: #218838; } /* Garder hover sombre */
        .btn-desiderata.btn-interro { background-color: var(--gris-neutre-bouton); } .btn-desiderata.btn-interro:hover { background-color: var(--gris-neutre-bouton-hover); }
        .btn-desiderata.btn-x { background-color: var(--rouge-nok); } .btn-desiderata.btn-x:hover { background-color: #c82333; } /* Garder hover sombre */

        /* Colonnes Jours Désidératats */
        #tableau-désidératats th:nth-child(n+3), #tableau-désidératats-soir th:nth-child(n+3) { white-space: nowrap; width: 40px; text-align: center; padding: 2px; height: 40px; background-color: var(--rose-moyen); box-sizing: border-box; }
        #tableau-désidératats td:nth-child(n+3), #tableau-désidératats-soir td:nth-child(n+3) { white-space: nowrap; width: 40px; text-align: center; padding: 2px; height: 40px; vertical-align: middle; box-sizing: border-box; }
        #tableau-désidératats select, #tableau-désidératats-soir select { padding: 5px 2px; border: 1px solid var(--gris-bordure); border-radius: 3px; background-color: white; width: 90%; box-sizing: border-box; text-align: center; appearance: none; -webkit-appearance: none; -moz-appearance: none; cursor: pointer; color: #333; font-weight: normal; }
        #tableau-désidératats select:focus, #tableau-désidératats-soir select:focus { outline: 2px solid var(--rose-principal); border-color: var(--rose-principal); }
        #tableau-désidératats select[style*="bold"], #tableau-désidératats-soir select[style*="bold"] { font-weight: bold; }
        #tableau-désidératats select[style*="red"], #tableau-désidératats-soir select[style*="red"] { color: var(--rouge-nok); }
        #tableau-désidératats select[style*="green"], #tableau-désidératats-soir select[style*="green"] { color: var(--vert-ok); }

        /* --- Styles Planning Généré --- */
        #tableau-emploi-du-temps td.Liste-assigne { font-weight: bold; color: var(--bleu-matin); }
        #tableau-emploi-du-temps-soir td.Liste-assigne { font-weight: bold; color: var(--mauve-soir); }
        #tableau-emploi-du-temps th.weekend, #tableau-emploi-du-temps td.weekend, #tableau-emploi-du-temps-soir th.weekend, #tableau-emploi-du-temps-soir td.weekend, #tableau-combiné th.weekend, #tableau-combiné td.weekend { background-color: var(--rose-clair) !important; }
        .repos { color: var(--rouge-nok); font-weight: bold; text-align: center; }
        #tableau-emploi-du-temps td.weekend.repos, #tableau-emploi-du-temps-soir td.weekend.repos, #tableau-combiné td.weekend span.repos { background-color: var(--rose-clair) !important; }
        #tableau-emploi-du-temps td.repos:not(.weekend), #tableau-emploi-du-temps-soir td.repos:not(.weekend), #tableau-combiné td:not(.weekend) span.repos { background-color: white !important; }
        #tableau-emploi-du-temps th:nth-child(1), #tableau-emploi-du-temps td:nth-child(1), #tableau-emploi-du-temps-soir th:nth-child(1), #tableau-emploi-du-temps-soir td:nth-child(1), #tableau-combiné th:nth-child(1), #tableau-combiné td:nth-child(1) { position: sticky; left: 0; background-color: white; z-index: 1; min-width: 110px; font-weight: bold; white-space: normal; border-right: 2px solid var(--gris-bordure); box-sizing: border-box; }
        #tableau-emploi-du-temps tbody tr:nth-child(even) td:nth-child(1), #tableau-emploi-du-temps-soir tbody tr:nth-child(even) td:nth-child(1), #tableau-combiné tbody tr:nth-child(even) td:nth-child(1) { background-color: var(--rose-pale); }
        #tableau-emploi-du-temps th:nth-child(2), #tableau-emploi-du-temps td:nth-child(2), #tableau-emploi-du-temps-soir th:nth-child(2), #tableau-emploi-du-temps-soir td:nth-child(2) { background-color: var(--rose-pale); font-weight: bold; width: 40px; text-align: center; padding: 8px 2px; position: sticky; left: 110px; z-index: 1; border-right: 1px solid var(--gris-bordure); box-sizing: border-box; }
        #tableau-emploi-du-temps tbody tr:nth-child(even) td:nth-child(2), #tableau-emploi-du-temps-soir tbody tr:nth-child(even) td:nth-child(2){ background-color: var(--rose-pale); }
        #tableau-emploi-du-temps tr.verification-row td:nth-child(1), #tableau-emploi-du-temps-soir tr.verification-row td:nth-child(1), #tableau-combiné tr.verification-row td:nth-child(1) { position: sticky; left: 0; z-index: 1; background-color: var(--gris-verif) !important; font-weight: bold; text-align: left; padding-left: 8px; min-width: 110px; border-right: 2px solid var(--gris-bordure); box-sizing: border-box; }
        #tableau-emploi-du-temps tr.verification-row td:not(:nth-child(1)), #tableau-emploi-du-temps-soir tr.verification-row td:not(:nth-child(1)), #tableau-combiné tr.verification-row td:not(:nth-child(1)) { background-color: var(--gris-verif); box-sizing: border-box; }
        #tableau-emploi-du-temps tr.verification-row td.weekend, #tableau-emploi-du-temps-soir tr.verification-row td.weekend, #tableau-combiné tr.verification-row td.weekend { background-color: #f5e6ea !important; }
        tr.verification-row { font-size: 10px; height: 20px; }
        tr.verification-row td { font-weight: bold; text-align: center; padding: 2px; border-bottom: 1px solid var(--gris-bordure); vertical-align: middle; box-sizing: border-box; }
        tr.verification-row td.ok { color: var(--vert-ok); }
        tr.verification-row td.nok { color: var(--rouge-nok); }
        #tableau-emploi-du-temps th:nth-child(n+3), #tableau-emploi-du-temps-soir th:nth-child(n+3) { min-width: 18px; box-sizing: border-box; }
        #tableau-emploi-du-temps td:nth-child(n+3), #tableau-emploi-du-temps-soir td:nth-child(n+3) { font-size: 13px; padding: 6px 1px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; text-align: center; height: 40px; box-sizing: border-box; }
        #tableau-combiné th:nth-child(n+2) { min-width: 18px; font-size: 11px; box-sizing: border-box; }
        #tableau-combiné td:nth-child(n+2) { font-size: 13px; padding: 2px 1px; text-align: center; vertical-align: top; height: 40px; line-height: 1.3; box-sizing: border-box; }
        #tableau-combiné td div { margin-bottom: 2px; }
        #tableau-combiné td div.assign-matin { color: var(--bleu-matin); font-weight: bold; text-align: center; cursor: grab; }
        #tableau-combiné td div.assign-soir { color: var(--mauve-soir); text-align: center; cursor: grab; }
        #tableau-combiné td span.repos { display: block; text-align: center; }
        #tableau-combiné tr.verification-row td { height: 20px; box-sizing: border-box; }
        #tableau-combiné tr.verification-row.verif-matin td { border-bottom-style: dashed; }
        #tableau-combiné tr.verification-row.verif-soir td { border-bottom-style: solid; }
        #tableau-combiné td.editable { cursor: pointer; }
        #tableau-combiné td.editable:hover { background-color: #f0f0f0; outline: 1px dashed #aaa; }
        #tableau-combiné td.drop-allowed { background-color: var(--drop-zone-bg) !important; outline: 2px dashed var(--bleu-matin); }
        .dragging { opacity: var(--dragging-opacity); border: 1px dashed #333; }

        /* --- Menus, Boutons, Overlay etc. --- */
        select#select-mois { padding: 8px 12px; border: 1px solid var(--rose-moyen); border-radius: 4px; background-color: white; color: #333; font-size: 16px; margin: 0 20px 20px 5px; }
        select#select-mois:focus { outline: none; border-color: var(--rose-principal); box-shadow: 0 0 0 2px var(--rose-semi-transparent); }
        .menu-collaborateurs { position: relative; display: inline-block; margin: 15px 10px 15px 0; }
        .menu-btn { padding: 10px 15px; background-color: var(--rose-moyen); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; }
        .menu-btn:hover { background-color: var(--rose-principal); }
        .menu-content { display: none; position: absolute; background-color: white; min-width: 300px; box-shadow: 0 8px 16px rgba(0,0,0,0.2); z-index: 10; border-radius: 4px; padding: 15px; right: 0; bottom: auto; top: 100%; margin-top: 2px; }
        .menu-section { margin-bottom: 15px; } .menu-section:last-child { margin-bottom: 0; }
        .menu-section h3 { margin-top: 0; margin-bottom: 8px; color: var(--rose-principal); font-size: 16px; }
        .menu-input { width: 100%; padding: 8px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        .menu-action-btn { padding: 8px 12px; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; margin-right: 5px; }
        .btn-ajouter { background-color: var(--vert-ok); color: white; } .btn-supprimer { background-color: var(--rouge-nok); color: white; }
        .menu-action-btn:hover { opacity: 0.9; }
        .menu-reset-container { position: fixed; bottom: 20px; left: 20px; z-index: 10; }
        .menu-reset-btn { padding: 10px 15px; background-color: var(--rouge-nok); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .menu-reset-btn:hover { background-color: #c82333; }
        #regenerate-container { position: fixed; bottom: 20px; right: 20px; z-index: 10; }
        #regenerate-container button { font-size: 15px; padding: 10px 20px; background-color: var(--rose-moyen); color: white; border: none; border-radius: 5px; cursor: pointer; text-align: center; transition: background-color 0.3s; box-shadow: 0 2px 5px rgba(0,0,0,0.1); min-width: 160px; }
        #regenerate-container button:hover { background-color: var(--rose-principal); }
        #menu-reset-content { background-color: white; min-width: 250px; box-shadow: 0 8px 16px rgba(0,0,0,0.2); z-index: 10; border-radius: 4px; padding: 15px; left: 0; bottom: 100%; top: auto; margin-bottom: 5px; }
        .menu-content.show { display: block; }
        #menu-reset-content button { display: block; width: 100%; padding: 10px; margin-bottom: 8px; text-align: left; background-color: #f8f9fa; border: 1px solid #dee2e6; border-radius: 4px; cursor: pointer; font-size: 14px; color: #333; }
        #menu-reset-content button:last-child { margin-bottom: 0; }
        #menu-reset-content button:hover { background-color: #e9ecef; border-color: #adb5bd; }
        #menu-reset-content h3 { color:var(--rose-moyen); margin-top: 0; margin-bottom: 8px; }
        .overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.2); z-index: 5; }
        .overlay.show { display: block; }
        .button-group { display: flex; justify-content: center; gap: 15px; margin-top: 30px; flex-wrap: wrap; }
        .button-group button { font-size: 15px; padding: 10px 20px; background-color: var(--rose-moyen); color: white; border: none; border-radius: 5px; cursor: pointer; text-align: center; transition: background-color 0.3s; box-shadow: 0 2px 5px rgba(0,0,0,0.1); min-width: 160px; }
        .button-group button:hover { background-color: var(--rose-principal); }
        .table-container { overflow-x: auto; max-width: 100%; margin-bottom: 20px; position: relative; }
        #message-erreur-couverture, #message-erreur-couverture-soir { color: var(--rouge-nok); background-color: #ffe0e0; /* Fond pâle commun */ border: 1px solid var(--rouge-nok); padding: 10px; margin: 10px 0; border-radius: 4px; display: none; }
        #message-info-chargement { color: var(--vert-ok); background-color: #e0ffe0; /* Fond pâle commun */ border: 1px solid var(--vert-ok); padding: 10px; margin: 10px 0; border-radius: 4px; display: none; text-align: center; }

        /* Sections Repliables (H2) */
        .collapsible-trigger { cursor: pointer; user-select: none; padding-top: 10px; padding-bottom: 10px; transition: background-color 0.2s ease; position: relative; display: flex; justify-content: space-between; align-items: center; }
        .collapsible-trigger:hover { background-color: var(--rose-pale); }
        .collapsible-trigger .arrow { font-size: 0.8em; margin-left: 10px; }
        .contenu-collapsible { display: none; padding-left: 15px; border-left: 3px solid var(--rose-clair); margin-left: 5px; margin-top: 10px; background-color: white; }
        .section-collapsible.active > .contenu-collapsible { display: block; }

        /* PDF Export */
        .pdf-capture-mode .overlay { display: none !important; }
        #pdf-export-loader { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: rgba(255, 255, 255, 0.9); padding: 20px 30px; border-radius: 10px; box-shadow: 0 5px 20px var(--rose-semi-transparent); z-index: 1001; border: 2px solid var(--rose-moyen); flex-direction: column; align-items: center; justify-content: center; gap: 10px; text-align: center; }
        #pdf-export-loader img { max-height: 60px; width: auto; margin-bottom: 5px; }
        #pdf-export-loader span { font-size: 1.1em; font-weight: bold; color: var(--rose-principal); }

        /* --- Styles pour Colonne Compétences Repliable --- */
        #tableau-désidératats.competences-hidden th:first-child, #tableau-désidératats.competences-hidden td:first-child,
        #tableau-désidératats-soir.competences-hidden th:first-child, #tableau-désidératats-soir.competences-hidden td:first-child { display: none; }
        #tableau-désidératats.competences-hidden th:nth-child(2), #tableau-désidératats.competences-hidden td:nth-child(2),
        #tableau-désidératats-soir.competences-hidden th:nth-child(2), #tableau-désidératats-soir.competences-hidden td:nth-child(2) { left: 0; border-left: none; }
        .btn-toggle-competences-col { display: block; margin: 10px 0 5px 0; padding: 6px 12px; font-size: 13px; background-color: var(--rose-clair); color: var(--rose-principal); border: 1px solid var(--rose-moyen); border-radius: 4px; cursor: pointer; text-align: center; transition: background-color 0.2s, color 0.2s; }
        .btn-toggle-competences-col:hover { background-color: var(--rose-moyen); color: white; }
        /* --- Styles spécifiques aux thèmes --- */

        /* Thème Orange */
        body.theme-orange {
            background-color: var(--body-bg-orange);
            --rose-principal: var(--orange-principal);
            --rose-moyen: var(--orange-moyen);
            --rose-clair: var(--orange-clair);
            --rose-pale: var(--orange-pale);
            --rose-semi-transparent: var(--orange-semi-transparent);
            --vert-ok: var(--vert-ok-orange);
            --rouge-nok: var(--rouge-nok-orange);
            /* Ajustements spécifiques orange */
            .competence-label input[type="checkbox"] { accent-color: var(--orange-principal); }
            #tableau-désidératats select:focus, #tableau-désidératats-soir select:focus { outline: 2px solid var(--orange-principal); border-color: var(--orange-principal); }
            #message-erreur-couverture, #message-erreur-couverture-soir { color: var(--rouge-nok-orange); border: 1px solid var(--rouge-nok-orange); background-color: #fff0e0; /* Fond erreur orange pâle */ }
            #message-info-chargement { color: var(--vert-ok-orange); border: 1px solid var(--vert-ok-orange); background-color: #f0fff0; /* Fond info vert pâle */ }
            select#select-mois { border: 1px solid var(--orange-moyen); }
            select#select-mois:focus { border-color: var(--orange-principal); box-shadow: 0 0 0 2px var(--orange-semi-transparent); }
            .menu-btn, #regenerate-container button, .button-group button { background-color: var(--orange-moyen); }
            .menu-btn:hover, #regenerate-container button:hover, .button-group button:hover { background-color: var(--orange-principal); }
            .menu-section h3 { color: var(--orange-principal); }
            #menu-reset-content h3 { color: var(--orange-moyen); }
            .collapsible-trigger:hover { background-color: var(--orange-pale); }
            .contenu-collapsible { border-left: 3px solid var(--orange-clair); }
            .btn-toggle-competences-col { background-color: var(--orange-clair); color: var(--orange-principal); border: 1px solid var(--orange-moyen); }
            .btn-toggle-competences-col:hover { background-color: var(--orange-moyen); color: white; }
            #pdf-export-loader { border: 2px solid var(--orange-moyen); box-shadow: 0 5px 20px var(--orange-semi-transparent); }
            #pdf-export-loader span { color: var(--orange-principal); }
            #theme-selector { border-color: var(--orange-moyen); }
        }

        /* Thème Bleu */
        body.theme-blue {
            background-color: var(--body-bg-bleu);
            --rose-principal: var(--bleu-p-principal);
            --rose-moyen: var(--bleu-p-moyen);
            --rose-clair: var(--bleu-p-clair);
            --rose-pale: var(--bleu-p-pale);
            --rose-semi-transparent: var(--bleu-p-semi-transparent);
            --vert-ok: var(--vert-ok-bleu);
            --rouge-nok: var(--rouge-nok-bleu);
            /* --bleu-matin: #17a2b8; */ /* Optionnel */
            /* --mauve-soir: #6f42c1; */ /* Optionnel */
            /* Ajustements spécifiques bleu */
            .competence-label input[type="checkbox"] { accent-color: var(--bleu-p-principal); }
            #tableau-désidératats select:focus, #tableau-désidératats-soir select:focus { outline: 2px solid var(--bleu-p-principal); border-color: var(--bleu-p-principal); }
            #message-erreur-couverture, #message-erreur-couverture-soir { color: var(--rouge-nok-bleu); border: 1px solid var(--rouge-nok-bleu); background-color: #f8d7da; }
            #message-info-chargement { color: var(--vert-ok-bleu); border: 1px solid var(--vert-ok-bleu); background-color: #d1e7dd; }
            select#select-mois { border: 1px solid var(--bleu-p-moyen); }
            select#select-mois:focus { border-color: var(--bleu-p-principal); box-shadow: 0 0 0 2px var(--bleu-p-semi-transparent); }
            .menu-btn, #regenerate-container button, .button-group button { background-color: var(--bleu-p-moyen); }
            .menu-btn:hover, #regenerate-container button:hover, .button-group button:hover { background-color: var(--bleu-p-principal); }
            .menu-section h3 { color: var(--bleu-p-principal); }
            #menu-reset-content h3 { color: var(--bleu-p-moyen); }
            .collapsible-trigger:hover { background-color: var(--bleu-p-pale); }
            .contenu-collapsible { border-left: 3px solid var(--bleu-p-clair); }
            .btn-toggle-competences-col { background-color: var(--bleu-p-clair); color: var(--bleu-p-principal); border: 1px solid var(--bleu-p-moyen); }
            .btn-toggle-competences-col:hover { background-color: var(--bleu-p-moyen); color: white; }
            #pdf-export-loader { border: 2px solid var(--bleu-p-moyen); box-shadow: 0 5px 20px var(--bleu-p-semi-transparent); }
            #pdf-export-loader span { color: var(--bleu-p-principal); }
            #theme-selector { border-color: var(--bleu-p-moyen); }
        }

        /* Thème Vert */
        body.theme-green {
            background-color: var(--body-bg-vert);
            --rose-principal: var(--vert-p-principal);
            --rose-moyen: var(--vert-p-moyen);
            --rose-clair: var(--vert-p-clair);
            --rose-pale: var(--vert-p-pale);
            --rose-semi-transparent: var(--vert-p-semi-transparent);
            --vert-ok: var(--vert-ok-vert);
            --rouge-nok: var(--rouge-nok-vert);
            /* --bleu-matin: #20c997; */ /* Optionnel */
            /* --mauve-soir: #6610f2; */ /* Optionnel */
            /* Ajustements spécifiques vert */
            .competence-label input[type="checkbox"] { accent-color: var(--vert-p-principal); }
            #tableau-désidératats select:focus, #tableau-désidératats-soir select:focus { outline: 2px solid var(--vert-p-principal); border-color: var(--vert-p-principal); }
            #message-erreur-couverture, #message-erreur-couverture-soir { color: var(--rouge-nok-vert); border: 1px solid var(--rouge-nok-vert); background-color: #f8d7da; }
            #message-info-chargement { color: var(--vert-ok-vert); border: 1px solid var(--vert-ok-vert); background-color: #d1e7dd; }
            select#select-mois { border: 1px solid var(--vert-p-moyen); }
            select#select-mois:focus { border-color: var(--vert-p-principal); box-shadow: 0 0 0 2px var(--vert-p-semi-transparent); }
            .menu-btn, #regenerate-container button, .button-group button { background-color: var(--vert-p-moyen); }
            .menu-btn:hover, #regenerate-container button:hover, .button-group button:hover { background-color: var(--vert-p-principal); }
            .menu-section h3 { color: var(--vert-p-principal); }
            #menu-reset-content h3 { color: var(--vert-p-moyen); }
            .collapsible-trigger:hover { background-color: var(--vert-p-pale); }
            .contenu-collapsible { border-left: 3px solid var(--vert-p-clair); }
            .btn-toggle-competences-col { background-color: var(--vert-p-clair); color: var(--vert-p-principal); border: 1px solid var(--vert-p-moyen); }
            .btn-toggle-competences-col:hover { background-color: var(--vert-p-moyen); color: white; }
            #pdf-export-loader { border: 2px solid var(--vert-p-moyen); box-shadow: 0 5px 20px var(--vert-p-semi-transparent); }
            #pdf-export-loader span { color: var(--vert-p-principal); }
            #theme-selector { border-color: var(--vert-p-moyen); }
        }

        /* --- Positionnement et Style Sélecteur Thème --- */
        .theme-switcher-container {
            position: absolute;
            top: 15px; /* Ajuster si nécessaire */
            right: 20px;
            z-index: 15;
            display: flex;
            align-items: center;
        }
        .theme-switcher-container label {
            margin-right: 5px;
            font-size: 13px;
            color: var(--gris-neutre-bouton); /* Couleur neutre pour le label */
        }
        #theme-selector {
            padding: 4px 6px;
            font-size: 13px;
            border-radius: 4px;
            border: 1px solid var(--gris-bordure); /* Bordure par défaut */
            background-color: var(--blanc);
            cursor: pointer;
            margin-left: 3px;
            transition: border-color 0.3s; /* Transition pour la bordure si thème change */
        }


    </style>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" integrity="sha512-BNaRQnYJYiPSqHHDb58B0yaPfCu+Wgds8Gp/gU33kqBtgNS4tSPHuGibyoeqMV/TJlSKda6FXzoEyYGjTe+vXA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" integrity="sha512-qZvrmS2ekKPF2mSznTQsxqPgnpkI4DNTlrdUmTzrDgektczlKNRRhy5X5AAOnx5S09ydFYWWNSfcEqDTTHgtNA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

</head>
<body>
    <div class="container">
        <div class="theme-switcher-container">
            <label for="theme-selector" style="margin-right: 5px; font-size: 13px; color: var(--gris-neutre-bouton);">Thème:</label>
            <select id="theme-selector" onchange="changeTheme()" title="Choisir le thème de couleur">
                <option value="rose">Rose</option>
                <option value="orange">Orange</option>
                <option value="blue">Bleu</option>
                <option value="green">Vert</option>
            </select>
        </div>

        <h1>Planificateur d'horaire</h1>

        <label for="select-mois">Mois :</label>
        <select id="select-mois" onchange="changerMois()">
            <option value="0">Janvier</option> <option value="1">Février</option> <option value="2">Mars</option>
            <option value="3">Avril</option> <option value="4">Mai</option> <option value="5">Juin</option>
            <option value="6">Juillet</option> <option value="7">Août</option> <option value="8">Septembre</option>
            <option value="9">Octobre</option> <option value="10">Novembre</option> <option value="11">Décembre</option>
        </select>

        <div class="menu-collaborateurs">
             <button class="menu-btn" onclick="toggleMenuCollaborateurs()">Gérer les collaborateurs</button>
             <div id="menu-collaborateurs-content" class="menu-content">
                 <div class="menu-section"><h3>Ajouter</h3><input type="text" id="nouveau-collaborateur" class="menu-input" placeholder="Nom"><button class="menu-action-btn btn-ajouter" onclick="ajouterCollaborateur()">Ajouter</button></div> <hr> <div class="menu-section"><h3>Supprimer</h3><select id="select-supprimer" class="menu-input"></select><button class="menu-action-btn btn-supprimer" onclick="supprimerCollaborateur()">Supprimer</button></div>
             </div>
        </div>
        <div id="overlay-menus" class="overlay"></div> <div id="message-info-chargement"></div>
        <div id="pdf-export-loader"></div>

        <div class="section-collapsible active" id="section-details-matin">
             <h2 class="collapsible-trigger">Matin : Disponibilités et compétences</h2>
             <div class="contenu-collapsible">
                 <h2>Matin (<span class="btn-desiderata btn-v">V</span>: Travail, <span class="btn-desiderata btn-x">X</span>: Repos, <span class="btn-desiderata btn-interro">?</span>: Indifférent)</h2>
                 <div style="margin-bottom: 15px;">
                     <label for="upload-desiderata-matin">Importer Désidératats Matin (.csv):</label>
                     <input type="file" id="upload-desiderata-matin" accept=".csv" style="display: inline-block; margin-left: 10px;">
                     <button onclick="importerDesideratas('matin')" style="margin-left: 10px; padding: 5px 10px; font-size: 14px;">Charger Fichier Matin</button>
                 </div>
                 <button id="btn-toggle-competences-matin" class="btn-toggle-competences-col" onclick="toggleCompetencesViaButton(this, 'tableau-désidératats')">
                    Masquer Compétences
                 </button>
                <div class="table-container">
                     <table id="tableau-désidératats"> <thead><tr><th>Comp.</th><th>Collab.</th></tr></thead> <tbody></tbody>
                     </table>
                 </div>
             </div>
        </div>

        <div class="section-collapsible" id="section-edt-matin">
             <h2 class="collapsible-trigger">Emploi du temps généré pour le matin</h2>
             <div class="contenu-collapsible">
                <div id="message-erreur-couverture"></div>
                <div class="table-container"> <table id="tableau-emploi-du-temps"><thead><tr></tr></thead><tbody></tbody></table> </div>
             </div>
        </div>

        <hr> 


        <div class="section-collapsible active" id="section-details-soir">
            <h2 class="collapsible-trigger">Soir : Disponibilités et compétences</h2>
            <div class="contenu-collapsible">
                <h2>Soir (<span class="btn-desiderata btn-v">V</span>: Travail, <span class="btn-desiderata btn-x">X</span>: Repos, <span class="btn-desiderata btn-interro">?</span>: Indifférent)</h2>
                <div style="margin-bottom: 15px;">
                    <label for="upload-desiderata-soir">Importer Désidératats Soir (.csv):</label>
                    <input type="file" id="upload-desiderata-soir" accept=".csv" style="display: inline-block; margin-left: 10px;">
                    <button onclick="importerDesideratas('soir')" style="margin-left: 10px; padding: 5px 10px; font-size: 14px;">Charger Fichier Soir</button>
                </div>
                <button id="btn-toggle-competences-soir" class="btn-toggle-competences-col" onclick="toggleCompetencesViaButton(this, 'tableau-désidératats-soir')">
                    Masquer Compétences
                </button>
                <div class="table-container">
                    <table id="tableau-désidératats-soir"> <thead><tr><th>Comp.</th><th>Collab.</th></tr></thead> <tbody></tbody>
                    </table>
                </div>
            </div>
       </div>

       <div class="section-collapsible" id="section-edt-soir">
            <h2 class="collapsible-trigger">Emploi du temps généré pour le soir</h2>
            <div class="contenu-collapsible">
                <div id="message-erreur-couverture-soir"></div>
                <div class="table-container"> <table id="tableau-emploi-du-temps-soir"><thead><tr></tr></thead><tbody></tbody></table> </div>
            </div>
       </div>

       <hr> <h2 style="margin-top: 30px;">Planning Global (Cliquer Soir pour modifier / Glisser-Déposer Matin/Soir)</h2>
       <div class="table-container"> <table id="tableau-combiné"> <thead><tr><th>Collaborateur</th></tr></thead> <tbody></tbody> </table> </div>

       <div class="button-group">
            <button onclick="exporterTableauEnPDF('tableau-combiné', 'Global')" title="Télécharge le planning global Matin/Soir">Exporter Planning Global (PDF)</button>

       </div>
       <div id="regenerate-container"> <button onclick="forcerRegeneration()" title="Relance l'algorithme d'assignation. Écrase le planning sauvegardé.">Regénérer les Plannings</button> </div>
       <div class="menu-reset-container">
            <button class="menu-reset-btn" onclick="toggleMenuReset()" title="Options pour effacer les données">Réinitialiser...</button>
            <div id="menu-reset-content" class="menu-content">
                <h3 style="margin-top:0; margin-bottom: 8px;">Mois Courant</h3>
                <button onclick="resetDesiderataMois('désidératats', 'Matin')" title="Efface V/X/? Matin mois courant">Effacer Désidératats Matin (mois)</button>
                <button onclick="resetDesiderataMois('désidératats-soir', 'Soir')" title="Efface V/X/? Soir mois courant">Effacer Désidératats Soir (mois)</button>
                <button onclick="effacerEDTSauvegardeMoisCourant(true)" title="Supprime le planning généré sauvegardé">Effacer Planning Sauvegardé (mois)</button>
                <hr>
                <h3 style="margin-bottom: 8px;">Toutes Données</h3>
                <button onclick="resetCompetencesToutes('Listes', 'Compétences Matin')" title="Décoche toutes compétences Matin">Effacer Compétences Matin (tout)</button>
                <button onclick="resetCompetencesToutes('Aptitudes-Soir', 'Aptitudes Soir')" title="Décoche toutes aptitudes Soir">Effacer Aptitudes Soir (tout)</button>
                <hr>
                <button onclick="resetComplet()" style="background-color: #ffe0e0; color: var(--rouge-nok); border-color: var(--rouge-nok);" title="ATTENTION: Efface TOUT !">Réinitialisation Complète !</button>
            </div>
       </div>

    </div> 


<script>
    // --- CONSTANTES ---
    let collaborateurs = ['Benjamin', 'Caroline', 'Nora', 'Radj', 'Baptiste', 'Sevan', 'Miriel', 'Jean-Semy', 'Adam', 'Chloé', 'Thomas', 'Victorine', 'Dimitiri', 'Rémi', 'Elisa', 'Paula', 'Laurine'];
    const listesMatin = ['m.1', 'm.2', 'm.3', 'm.4', 'm.5', 'm.6', 'm.7'];
    const aptitudesSoir = ['s.V', 's.B', 's.M', 's.R', 's.J'];
    const MAX_TRIES_JOUR = 7;
    const MAX_TRIES_SOIR_OPTIMIZATION = 300;
    let globalEmploiDuTempsMatin = {};
    let globalEmploiDuTempsSoir = {};
    let globalPreferencesSoir = {};
    let anneeActuelle = new Date().getFullYear();
    const COMPETENCES_HIDDEN_LS_KEY = 'competencesHiddenState';
    // --- Constantes Thème ---
    const THEME_LS_KEY = 'horaireAppTheme';
    const themeMetaTag = document.querySelector('meta[name="theme-color"]');
    const themes = ['rose', 'orange', 'blue', 'green']; // Ordre/Validation
    const pwaThemeColors = { // Couleurs pour la barre PWA/Navigateur
        rose: '#D9006C',
        orange: '#FF8C00', // Correspond à --orange-principal
        blue: '#007bff',   // Correspond à --bleu-p-principal
        green: '#28a745'   // Correspond à --vert-p-principal
    };


    // --- FONCTIONS POUR LE THÈME ---

    /**
     * Applique le thème sélectionné dans le dropdown et sauvegarde.
     */
    function changeTheme() {
        const selector = document.getElementById('theme-selector');
        if (!selector) return; // Sécurité
        const newTheme = selector.value;

        // Appliquer le thème visuellement (UI + PWA color + MàJ select si besoin)
        applyTheme(newTheme);

        // Sauvegarder la préférence
        try {
            localStorage.setItem(THEME_LS_KEY, newTheme);
            console.log("Thème sauvegardé:", newTheme);
        } catch (e) {
            console.error("Impossible de sauvegarder le thème dans localStorage:", e);
        }
    }

    /**
     * Applique le thème et met à jour la valeur du select.
     * @param {'rose' | 'orange' | 'blue' | 'green' | string | null} theme Le nom du thème à appliquer
     */
    function applyTheme(theme) {
        // 1. Valider le thème (sécurité + valeur par défaut)
        const validTheme = themes.includes(theme) ? theme : 'rose';

        // 2. Nettoyer anciennes classes de thème sur le body
        document.body.classList.remove('theme-orange', 'theme-blue', 'theme-green');

        // 3. Appliquer la nouvelle classe (sauf pour 'rose')
        if (validTheme !== 'rose') {
            document.body.classList.add(`theme-${validTheme}`);
        }

        // 4. Mettre à jour la couleur PWA/Navigateur
        if (themeMetaTag) {
            themeMetaTag.setAttribute('content', pwaThemeColors[validTheme]);
        }

        // 5. Mettre à jour la valeur sélectionnée dans le dropdown
        const selector = document.getElementById('theme-selector');
        if (selector && selector.value !== validTheme) {
            selector.value = validTheme;
        }

        console.log("Thème appliqué:", validTheme);
    }

    /**
     * Charge le thème sauvegardé depuis localStorage au chargement de la page.
     */
    function loadSavedTheme() {
        try {
            const savedTheme = localStorage.getItem(THEME_LS_KEY);
            // Appliquer le thème sauvegardé s'il est valide, sinon défaut 'rose'
            applyTheme(savedTheme); // applyTheme gère la validation et la mise à jour du select
        } catch (e) {
            console.error("Impossible de lire le thème depuis localStorage:", e);
            applyTheme('rose'); // Fallback
        }
    }


    // --- GESTION COLLABORATEURS & LOCALSTORAGE ---
    function chargerCollaborateurs() { /* ... (inchangé) ... */ const sauvegarde = localStorage.getItem('collaborateurs'); if (sauvegarde) { try { const parsed = JSON.parse(sauvegarde); if (!Array.isArray(parsed) || !parsed.every(item => typeof item === 'string')) { if (parsed.length > 0 || !Array.isArray(parsed)) { throw new Error("Invalid data format"); } collaborateurs = []; } else { collaborateurs = parsed; } } catch (e) { console.error("Erreur chargement/validation collaborateurs:", e); collaborateurs = ['Benjamin', 'Caroline', 'Nora', 'Radj', 'Baptiste', 'Sevan', 'Miriel', 'Jean-Semy', 'Adam', 'Chloé', 'Thomas', 'Victorine', 'Dimitiri', 'Rémi', 'Elisa', 'Paula', 'Laurine']; localStorage.removeItem('collaborateurs'); } } else { collaborateurs = ['Benjamin', 'Caroline', 'Nora', 'Radj', 'Baptiste', 'Sevan', 'Miriel', 'Jean-Semy', 'Adam', 'Chloé', 'Thomas', 'Victorine', 'Dimitiri', 'Rémi', 'Elisa', 'Paula', 'Laurine']; } mettreAJourSelectSuppression(); }
    function sauvegarderCollaborateurs() { /* ... (inchangé) ... */ localStorage.setItem('collaborateurs', JSON.stringify(collaborateurs)); }
    function mettreAJourSelectSuppression() { /* ... (inchangé) ... */ const select = document.getElementById('select-supprimer'); if (!select) return; select.innerHTML = '<option value="">-- Sélectionner --</option>'; collaborateurs.forEach(c => { const option = document.createElement('option'); option.value = c; option.textContent = c; select.appendChild(option); }); }
    function ajouterCollaborateur() { /* ... (inchangé) ... */ const input = document.getElementById('nouveau-collaborateur'); const nom = input.value.trim(); if (nom && !collaborateurs.some(c => c.toLowerCase() === nom.toLowerCase())) { collaborateurs.push(nom); sauvegarderCollaborateurs(); chargerCollaborateurs(); rafraichirTousLesTableauxEtEDT(true); input.value = ''; alert(`"${nom}" ajouté !`); fermerTousMenus(); } else if (collaborateurs.some(c => c.toLowerCase() === nom.toLowerCase())) { alert('Existe déjà !'); } else { alert('Nom invalide !'); } }
    function supprimerCollaborateur() { /* ... (inchangé) ... */ const select = document.getElementById('select-supprimer'); const nom = select.value; if (nom) { if (confirm(`Supprimer "${nom}" ?\nToutes ses préférences et compétences seront effacées.\nLes plannings sauvegardés pourraient devenir incohérents.`)) { const index = collaborateurs.findIndex(c => c === nom); if (index !== -1) { collaborateurs.splice(index, 1); sauvegarderCollaborateurs(); chargerCollaborateurs(); localStorage.removeItem(`Listes-${nom}`); localStorage.removeItem(`Aptitudes-Soir-${nom}`); for (let m = 0; m < 12; m++) { supprimerDonneesCollabLocalStorage(`désidératats-${m}`, nom); supprimerDonneesCollabLocalStorage(`désidératats-soir-${m}`, nom); } rafraichirTousLesTableauxEtEDT(true); select.value = ""; alert(`"${nom}" supprimé.`); fermerTousMenus(); } } } else { alert('Sélectionnez un collaborateur.'); } }
    function supprimerDonneesCollabLocalStorage(baseKey, collaborateur) { /* ... (inchangé) ... */ let donnees = JSON.parse(localStorage.getItem(baseKey)) || {}; let modifie = false; Object.keys(donnees).forEach(key => { if (key.startsWith(`${collaborateur}-`)) { delete donnees[key]; modifie = true; } }); if (modifie) { if (Object.keys(donnees).length > 0) localStorage.setItem(baseKey, JSON.stringify(donnees)); else localStorage.removeItem(baseKey); } }

    // --- GESTION MENUS ---
    function toggleMenuCollaborateurs() { /* ... (inchangé) ... */ const menu = document.getElementById('menu-collaborateurs-content'); const overlay = document.getElementById('overlay-menus'); const estOuvert = menu.classList.contains('show'); fermerTousMenus(); if (!estOuvert) { menu.classList.add('show'); overlay.classList.add('show'); } }
    function toggleMenuReset() { /* ... (inchangé) ... */ const menu = document.getElementById('menu-reset-content'); const overlay = document.getElementById('overlay-menus'); const estOuvert = menu.classList.contains('show'); fermerTousMenus(); if (!estOuvert) { menu.classList.add('show'); overlay.classList.add('show'); } }
    function fermerTousMenus() { /* ... (inchangé) ... */ document.querySelectorAll('.menu-content.show').forEach(menu => menu.classList.remove('show')); const overlay = document.getElementById('overlay-menus'); if(overlay) overlay.classList.remove('show'); }

    // --- FONCTION UTILITAIRE COULEUR SELECT (Dispo) ---
    function mettreAJourCouleurSelect(selectElement) { /* ... (inchangé) ... */ const valeur = selectElement.value; selectElement.style.fontWeight = (valeur === 'repos' || valeur === 'travailler') ? 'bold' : ''; selectElement.style.color = (valeur === 'repos') ? 'var(--rouge-nok)' : (valeur === 'travailler' ? 'var(--vert-ok)' : '#333'); }

    // --- FONCTION METTRE TOUT EN ---
    function mettreToutEn(collaborateur, valeurCible, typeTableau, tableId) { /* ... (inchangé) ... */ const selectMois = document.getElementById('select-mois'); const mois = parseInt(selectMois.value); const annee = anneeActuelle; const nombreJours = new Date(annee, mois + 1, 0).getDate(); const localStorageKeyPrefix = (typeTableau === 'matin') ? 'désidératats' : 'désidératats-soir'; const nomAffichage = (typeTableau === 'matin') ? 'Matin' : 'Soir'; const localStorageKey = `${localStorageKeyPrefix}-${mois}`; let actionTexte = ''; switch(valeurCible) { case 'travailler': actionTexte = "Voulu (V)"; break; case 'repos': actionTexte = "Repos (X)"; break; case 'indifferent': actionTexte = "Indifférent (?)"; break; default: return; } if (confirm(`Voulez-vous vraiment mettre tous les jours en "${actionTexte}" pour ${collaborateur} (${nomAffichage}) pour ce mois ?`)) { let donneesActuelles = JSON.parse(localStorage.getItem(localStorageKey)) || {}; for (let i = 1; i <= nombreJours; i++) { const cleTravail = `${collaborateur}-${i}-travail`; if (valeurCible === 'indifferent') delete donneesActuelles[cleTravail]; else donneesActuelles[cleTravail] = valeurCible; } if (Object.keys(donneesActuelles).length > 0) localStorage.setItem(localStorageKey, JSON.stringify(donneesActuelles)); else localStorage.removeItem(localStorageKey); const tableau = document.getElementById(tableId); if (tableau) { const tbody = tableau.querySelector('tbody'); const rows = tbody.querySelectorAll('tr'); for (const tr of rows) { const tdNomCell = tr.querySelector('td:nth-child(2)'); const spanNom = tdNomCell ? tdNomCell.querySelector('span:not(.button-group-desiderata)') : null; if (spanNom && spanNom.textContent.trim() === collaborateur) { const selects = tr.querySelectorAll('td:nth-child(n+3) select'); selects.forEach(select => { select.value = valeurCible; mettreAJourCouleurSelect(select); }); break; } } } effacerEDTSauvegardeMoisCourant(false); cacherMessageInfoChargement(); } }

    // --- TOGGLE COLONNE COMPETENCES VIA BOUTON EXTERNE ---
    function toggleCompetencesViaButton(buttonElement, tableId) { /* ... (inchangé) ... */ const table = document.getElementById(tableId); if (!table || !buttonElement) return; const isCollapsed = table.classList.toggle('competences-hidden'); buttonElement.textContent = isCollapsed ? 'Afficher Compétences' : 'Masquer Compétences'; const currentState = JSON.parse(localStorage.getItem(COMPETENCES_HIDDEN_LS_KEY)) || {}; currentState[tableId] = isCollapsed; localStorage.setItem(COMPETENCES_HIDDEN_LS_KEY, JSON.stringify(currentState)); }
    function applyStoredCompetenceVisibility() { /* ... (inchangé) ... */ const storedState = JSON.parse(localStorage.getItem(COMPETENCES_HIDDEN_LS_KEY)) || {}; const tableIds = ['tableau-désidératats', 'tableau-désidératats-soir']; tableIds.forEach(tableId => { const table = document.getElementById(tableId); const button = document.getElementById(`btn-toggle-competences-${tableId.includes('soir') ? 'soir' : 'matin'}`); if (!table || !button) return; const shouldBeCollapsed = storedState[tableId] || false; if (shouldBeCollapsed) { table.classList.add('competences-hidden'); button.textContent = 'Afficher Compétences'; } else { table.classList.remove('competences-hidden'); button.textContent = 'Masquer Compétences'; } }); }

    // --- GÉNÉRATION TABLEAUX DÉSIDÉRATATS ---
    function genererTableauDesideratats(mois, annee, tableId, localStorageKeyPrefix, competencesListe, competencesPrefix) { /* ... (inchangé - appelle applyStoredCompetenceVisibility à la fin) ... */ const tableau = document.getElementById(tableId); if (!tableau) return; const thead = tableau.querySelector('thead tr'); const tbody = tableau.querySelector('tbody'); if (!thead || !tbody) return; const nombreJours = new Date(annee, mois + 1, 0).getDate(); const localStorageKeyDesideratats = `${localStorageKeyPrefix}-${mois}`; const donneesDesideratats = JSON.parse(localStorage.getItem(localStorageKeyDesideratats)) || {}; const typeTableauStr = (localStorageKeyPrefix === 'désidératats') ? 'matin' : 'soir'; thead.innerHTML = '<th>Comp.</th><th>Collaborateur</th>'; for (let i = 1; i <= nombreJours; i++) { const th = document.createElement('th'); const jourDate = new Date(annee, mois, i); const jourSemaine = ['Di', 'Lu', 'Ma', 'Me', 'Je', 'Ve', 'Sa'][jourDate.getDay()]; th.innerHTML = `${jourSemaine}<br>${i}`; if (jourDate.getDay() === 0 || jourDate.getDay() === 6) th.classList.add('weekend'); thead.appendChild(th); } tbody.innerHTML = ''; collaborateurs.forEach(collaborateur => { const tr = document.createElement('tr'); const tdComp = document.createElement('td'); const localStorageKeyCompetencesCollab = `${competencesPrefix}-${collaborateur}`; const postesSelectionnes = JSON.parse(localStorage.getItem(localStorageKeyCompetencesCollab)) || []; competencesListe.forEach(poste => { const label = document.createElement('label'); label.classList.add('competence-label'); const checkbox = document.createElement('input'); checkbox.type = 'checkbox'; checkbox.value = poste; checkbox.dataset.collaborateur = collaborateur; checkbox.checked = postesSelectionnes.includes(poste); checkbox.addEventListener('change', (event) => { const cb = event.target; const collab = cb.dataset.collaborateur; const pst = cb.value; const lsKey = `${competencesPrefix}-${collab}`; let currentPostes = JSON.parse(localStorage.getItem(lsKey)) || []; if (cb.checked) { if (!currentPostes.includes(pst)) currentPostes.push(pst); } else { currentPostes = currentPostes.filter(item => item !== pst); } if (currentPostes.length > 0) localStorage.setItem(lsKey, JSON.stringify(currentPostes)); else localStorage.removeItem(lsKey); effacerEDTSauvegardeMoisCourant(false); cacherMessageInfoChargement(); }); label.appendChild(checkbox); label.appendChild(document.createTextNode(` ${poste}`)); tdComp.appendChild(label); }); tr.appendChild(tdComp); const tdNom = document.createElement('td'); const divNomContainer = document.createElement('div'); const spanNom = document.createElement('span'); spanNom.textContent = collaborateur; divNomContainer.appendChild(spanNom); const buttonContainer = document.createElement('span'); buttonContainer.classList.add('button-group-desiderata'); const btnToutV = document.createElement('button'); btnToutV.textContent = 'V'; btnToutV.classList.add('btn-desiderata', 'btn-v'); btnToutV.title = `Voulu (V)`; btnToutV.onclick = () => mettreToutEn(collaborateur, 'travailler', typeTableauStr, tableId); buttonContainer.appendChild(btnToutV); const btnToutInterro = document.createElement('button'); btnToutInterro.textContent = '?'; btnToutInterro.classList.add('btn-desiderata', 'btn-interro'); btnToutInterro.title = `Indifférent (?)`; btnToutInterro.onclick = () => mettreToutEn(collaborateur, 'indifferent', typeTableauStr, tableId); buttonContainer.appendChild(btnToutInterro); const btnToutX = document.createElement('button'); btnToutX.textContent = 'X'; btnToutX.classList.add('btn-desiderata', 'btn-x'); btnToutX.title = `Repos (X)`; btnToutX.onclick = () => mettreToutEn(collaborateur, 'repos', typeTableauStr, tableId); buttonContainer.appendChild(btnToutX); divNomContainer.appendChild(buttonContainer); tdNom.appendChild(divNomContainer); tr.appendChild(tdNom); for (let i = 1; i <= nombreJours; i++) { const tdCase = document.createElement('td'); const selectTravail = document.createElement('select'); selectTravail.innerHTML = `<option value="indifferent">?</option><option value="repos">X</option><option value="travailler">V</option>`; const cleTravail = `${collaborateur}-${i}-travail`; selectTravail.value = donneesDesideratats[cleTravail] || 'indifferent'; const jourDate = new Date(annee, mois, i); if (jourDate.getDay() === 0 || jourDate.getDay() === 6) tdCase.classList.add('weekend'); selectTravail.addEventListener('change', (event) => { const selectModifie = event.target; const nouvelleValeur = selectModifie.value; mettreAJourCouleurSelect(selectModifie); const donneesActuelles = JSON.parse(localStorage.getItem(localStorageKeyDesideratats)) || {}; if (nouvelleValeur === 'indifferent') delete donneesActuelles[cleTravail]; else donneesActuelles[cleTravail] = nouvelleValeur; if (Object.keys(donneesActuelles).length > 0) localStorage.setItem(localStorageKeyDesideratats, JSON.stringify(donneesActuelles)); else localStorage.removeItem(localStorageKeyDesideratats); effacerEDTSauvegardeMoisCourant(false); cacherMessageInfoChargement(); }); tdCase.appendChild(selectTravail); tr.appendChild(tdCase); mettreAJourCouleurSelect(selectTravail); } tbody.appendChild(tr); }); applyStoredCompetenceVisibility(); }
    function genererTableauDesideratatsMatin(mois, annee) { /* ... (inchangé) ... */ genererTableauDesideratats(mois, annee, 'tableau-désidératats', 'désidératats', listesMatin, 'Listes'); }
    function genererTableauDesideratatsSoir(mois, annee) { /* ... (inchangé) ... */ genererTableauDesideratats(mois, annee, 'tableau-désidératats-soir', 'désidératats-soir', aptitudesSoir, 'Aptitudes-Soir'); }

    // --- FONCTIONS UTILITAIRES EDT ---
    function shuffleArray(array) { /* ... (inchangé) ... */ for (let i = array.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [array[i], array[j]] = [array[j], array[i]]; } return array; }
    function choisirMoinsOccupe(candidats, emploiDuTempsConcerne) { /* ... (inchangé) ... */ if (!candidats || candidats.length === 0) return null; if (candidats.length === 1) return candidats[0]; return candidats.reduce((moinsOccupe, candidat) => { const joursTravailMoinsOccupe = Object.values(emploiDuTempsConcerne[moinsOccupe] || {}).filter(j => j !== null && j !== 'REPOS').length; const joursTravailCandidat = Object.values(emploiDuTempsConcerne[candidat] || {}).filter(j => j !== null && j !== 'REPOS').length; return joursTravailCandidat < joursTravailMoinsOccupe ? candidat : moinsOccupe; }, candidats[0]); }
    function estPosteCouvert(poste, jour, emploiDuTempsConcerne) { /* ... (inchangé) ... */ if (!emploiDuTempsConcerne) return false; return collaborateurs.some(collaborateur => emploiDuTempsConcerne[collaborateur]?.[jour - 1] === poste); }
    function assignerJourMatin(jour, preferences, competences, emploiDuTempsGlobal, tempEmploiJour, listeDesPostes) { /* ... (inchangé) ... */ const postesJourMelanges = shuffleArray([...listeDesPostes]); for (const poste of postesJourMelanges) { let estDejaAssigne = false; for (const assignation of tempEmploiJour.values()) { if (assignation === poste) { estDejaAssigne = true; break; } } if (estDejaAssigne) continue; const candidats = collaborateurs.filter(c => competences[c]?.includes(poste) && tempEmploiJour.get(c) === null); if (candidats.length > 0) { const candidatsTries = [...candidats].sort((a, b) => { const prefA = preferences[a]?.[jour] || 'indifferent'; const prefB = preferences[b]?.[jour] || 'indifferent'; if (prefA === 'indifferent' && prefB !== 'indifferent') return -1; if (prefB === 'indifferent' && prefA !== 'indifferent') return 1; if (prefA === 'travailler' && prefB !== 'travailler') return -1; if (prefB === 'travailler' && prefA !== 'travailler') return 1; const joursA = Object.values(emploiDuTempsGlobal[a] || {}).filter(p => p !== null && p !== 'REPOS').length; const joursB = Object.values(emploiDuTempsGlobal[b] || {}).filter(p => p !== null && p !== 'REPOS').length; return joursA - joursB; }); const elu = candidatsTries[0]; tempEmploiJour.set(elu, poste); } } }
    function verifierCouvertureJourMatin(tempEmploiJour, listeDesPostes) { /* ... (inchangé) ... */ const postesCouverts = new Set(); if (!(tempEmploiJour instanceof Map)) return false; for (const assignation of tempEmploiJour.values()) { if (assignation && assignation !== 'REPOS') { postesCouverts.add(assignation); } } return postesCouverts.size === listeDesPostes.length; }
    function tenterAssignationSoirOptimisation(jour, preferences, competences, emploiDuTempsMatin, listeDesPostes) { /* ... (inchangé) ... */ const tempEmploiJour = new Map(); const collaborateursUtilises = new Set(); const postesAssignes = new Set(); collaborateurs.forEach(c => { if (preferences[c]?.[jour] === 'repos') { tempEmploiJour.set(c, 'REPOS'); collaborateursUtilises.add(c); } else { tempEmploiJour.set(c, null); } }); const preferredCandidatesPool = collaborateurs.filter(c => !collaborateursUtilises.has(c) && (preferences[c]?.[jour] === 'travailler' || (emploiDuTempsMatin[c]?.[jour - 1] !== null && emploiDuTempsMatin[c]?.[jour - 1] !== 'REPOS')) && (competences[c] && competences[c].length > 0) ); if (preferredCandidatesPool.length < listeDesPostes.length) return null; const shuffledPostes = shuffleArray([...listeDesPostes]); const shuffledCandidats = shuffleArray([...preferredCandidatesPool]); for (const poste of shuffledPostes) { let posteAssigneCettePasse = false; for (const candidat of shuffledCandidats) { if (!collaborateursUtilises.has(candidat) && competences[candidat]?.includes(poste)) { tempEmploiJour.set(candidat, poste); collaborateursUtilises.add(candidat); postesAssignes.add(poste); posteAssigneCettePasse = true; break; } } if (!posteAssigneCettePasse) return null; } if (postesAssignes.size === listeDesPostes.length) return tempEmploiJour; else return null; }

    // --- GÉNÉRATION EMPLOI DU TEMPS MATIN/SOIR ---
    function genererEmploiDuTempsMatin() { /* ... (inchangé) ... */ console.time("Génération EDT Matin"); const selectMois = document.getElementById('select-mois'); const mois = parseInt(selectMois.value); const annee = anneeActuelle; const nombreJours = new Date(annee, mois + 1, 0).getDate(); const listeDesPostes = listesMatin; const localStorageKeyDesideratats = 'désidératats'; const localStorageKeyCompetencesPrefix = 'Listes'; const tableId = 'tableau-emploi-du-temps'; const messageId = 'message-erreur-couverture'; let emploiDuTemps = {}; const preferences = {}; const competences = {}; const desideratatsKey = `${localStorageKeyDesideratats}-${mois}`; const donneesDesideratats = JSON.parse(localStorage.getItem(desideratatsKey)) || {}; collaborateurs.forEach(c => { preferences[c] = {}; competences[c] = JSON.parse(localStorage.getItem(`${localStorageKeyCompetencesPrefix}-${c}`)) || []; emploiDuTemps[c] = Array(nombreJours).fill(null); for (let j = 1; j <= nombreJours; j++) { const cle = `${c}-${j}-travail`; preferences[c][j] = donneesDesideratats[cle] || 'indifferent'; if (preferences[c][j] === 'repos') emploiDuTemps[c][j - 1] = 'REPOS'; } }); const weekends = []; for (let jour = 1; jour <= nombreJours; jour++) { const date = new Date(annee, mois, jour); if (date.getDay() === 0) { const samedi = jour - 1; if (samedi >= 1 && new Date(annee, mois, samedi).getDay() === 6) weekends.push({ samedi: samedi, dimanche: jour }); } } for (let jour = 1; jour <= nombreJours; jour++) { const postesMelangesJour = shuffleArray([...listeDesPostes]); for (const poste of postesMelangesJour) { if (!estPosteCouvert(poste, jour, emploiDuTemps)) { const candidatsV = collaborateurs.filter(c => preferences[c]?.[jour] === 'travailler' && competences[c]?.includes(poste) && emploiDuTemps[c]?.[jour - 1] === null ); if (candidatsV.length > 0) { const choisi = choisirMoinsOccupe(candidatsV, emploiDuTemps); if (choisi && emploiDuTemps[choisi]) emploiDuTemps[choisi][jour - 1] = poste; } } } } const weekendsMelanges = shuffleArray([...weekends]); weekendsMelanges.forEach(we => { const { samedi, dimanche } = we; const postesMelangesWE = shuffleArray([...listeDesPostes]); for (const poste of postesMelangesWE) { const samediCouvert = estPosteCouvert(poste, samedi, emploiDuTemps); const dimancheCouvert = estPosteCouvert(poste, dimanche, emploiDuTemps); if (samediCouvert && dimancheCouvert) continue; let candidats2J = collaborateurs.filter(c => competences[c]?.includes(poste) && emploiDuTemps[c]?.[samedi - 1] === null && emploiDuTemps[c]?.[dimanche - 1] === null && preferences[c]?.[samedi] !== 'repos' && preferences[c]?.[dimanche] !== 'repos'); if (candidats2J.length > 0) { const choisi = choisirMoinsOccupe(candidats2J, emploiDuTemps); if (choisi && emploiDuTemps[choisi]) { if (!samediCouvert) emploiDuTemps[choisi][samedi - 1] = poste; if (!dimancheCouvert) emploiDuTemps[choisi][dimanche - 1] = poste; } continue; } if (!samediCouvert) { let candidatsS = collaborateurs.filter(c => competences[c]?.includes(poste) && emploiDuTemps[c]?.[samedi - 1] === null && preferences[c]?.[samedi] !== 'repos'); if (candidatsS.length > 0) { const eluS = choisirMoinsOccupe(candidatsS, emploiDuTemps); if (eluS && emploiDuTemps[eluS]) emploiDuTemps[eluS][samedi - 1] = poste; } } if (!estPosteCouvert(poste, dimanche, emploiDuTemps)) { let candidatsD = collaborateurs.filter(c => competences[c]?.includes(poste) && emploiDuTemps[c]?.[dimanche - 1] === null && preferences[c]?.[dimanche] !== 'repos'); if (candidatsD.length > 0) { const eluD = choisirMoinsOccupe(candidatsD, emploiDuTemps); if (eluD && emploiDuTemps[eluD]) emploiDuTemps[eluD][dimanche - 1] = poste; } } } }); for (let jour = 1; jour <= nombreJours; jour++) { const date = new Date(annee, mois, jour); if (date.getDay() === 0 || date.getDay() === 6) continue; const postesMelangesSemaine = shuffleArray([...listeDesPostes]); for (const poste of postesMelangesSemaine) { if (!estPosteCouvert(poste, jour, emploiDuTemps)) { let dispo = collaborateurs.filter(c => competences[c]?.includes(poste) && emploiDuTemps[c]?.[jour - 1] === null ); if (dispo.length > 0) { if (dispo.length > 1) { dispo.sort((a, b) => { const prefA = preferences[a]?.[jour]||'i'; const prefB = preferences[b]?.[jour]||'i'; if (prefA === 'i' && prefB !== 'i') return -1; if (prefB === 'i' && prefA !== 'i') return 1; if (prefA === 't' && prefB !== 't') return -1; if (prefB === 't' && prefA !== 't') return 1; const jA = emploiDuTemps[a]?.filter(p=>p&&p!='REPOS').length||0; const jB = emploiDuTemps[b]?.filter(p=>p&&p!='REPOS').length||0; return jA - jB; }); } const elu = dispo[0]; if (elu && emploiDuTemps[elu]) emploiDuTemps[elu][jour - 1] = poste; } } } } const joursProblemes = []; for (let j=1; j<=nombreJours; j++){let ok=true; for(const p of listeDesPostes){if(!estPosteCouvert(p,j,emploiDuTemps)){ok=false; break;}} if(!ok)joursProblemes.push(j);} if(joursProblemes.length > 0){ console.log(`Tentative correction Matin - Jours: ${joursProblemes.join(', ')}`); for(const j of joursProblemes){ let succes = false; for(let t=0; t<MAX_TRIES_JOUR; t++){ const tempJ = new Map(); collaborateurs.forEach(c => { tempJ.set(c, emploiDuTemps[c]?.[j-1]==='REPOS'?'REPOS':null); }); assignerJourMatin(j, preferences, competences, emploiDuTemps, tempJ, listeDesPostes); if(verifierCouvertureJourMatin(tempJ, listeDesPostes)){ console.log(`Correction Matin Jour ${j} OK (${t+1})`); for(const [collab, assign] of tempJ.entries()){if(emploiDuTemps[collab])emploiDuTemps[collab][j-1]=assign;} succes = true; break; } } if(!succes)console.log(`Echec correction Matin Jour ${j}`); } } else {console.log("Aucun jour Matin incomplet.");} globalEmploiDuTempsMatin = emploiDuTemps; afficherUnEmploiDuTemps(emploiDuTemps, mois, annee, nombreJours, preferences, tableId, messageId, listeDesPostes); console.timeEnd("Génération EDT Matin"); return emploiDuTemps; }
    function genererEmploiDuTempsSoir() { /* ... (inchangé) ... */ console.time("Génération EDT Soir"); const selectMois = document.getElementById('select-mois'); const mois = parseInt(selectMois.value); const annee = anneeActuelle; const nombreJours = new Date(annee, mois + 1, 0).getDate(); const listeDesPostes = aptitudesSoir; const localStorageKeyDesideratats = 'désidératats-soir'; const localStorageKeyCompetencesPrefix = 'Aptitudes-Soir'; const tableId = 'tableau-emploi-du-temps-soir'; const messageId = 'message-erreur-couverture-soir'; const emploiDuTempsMatin = globalEmploiDuTempsMatin; let emploiDuTemps = {}; const preferences = {}; const competences = {}; const desideratatsKey = `${localStorageKeyDesideratats}-${mois}`; const donneesDesideratats = JSON.parse(localStorage.getItem(desideratatsKey)) || {}; collaborateurs.forEach(c => { preferences[c] = {}; const competenceKey = `${localStorageKeyCompetencesPrefix}-${c}`; competences[c] = JSON.parse(localStorage.getItem(competenceKey)) || []; emploiDuTemps[c] = Array(nombreJours).fill(null); for (let jour = 1; jour <= nombreJours; jour++) { const clePref = `${c}-${jour}-travail`; preferences[c][jour] = donneesDesideratats[clePref] || 'indifferent'; if (preferences[c][jour] === 'repos') emploiDuTemps[c][jour - 1] = 'REPOS'; } }); globalPreferencesSoir = preferences; for (let jour = 1; jour <= nombreJours; jour++) { const postesPourPasses12 = shuffleArray([...listeDesPostes]); for (const poste of postesPourPasses12) { if (estPosteCouvert(poste, jour, emploiDuTemps)) continue; let candidatsV = collaborateurs.filter(c => competences[c]?.includes(poste) && preferences[c]?.[jour] === 'travailler' && emploiDuTemps[c]?.[jour - 1] === null); if (candidatsV.length > 0) { const choisiV = choisirMoinsOccupe(candidatsV, emploiDuTemps); if (choisiV && emploiDuTemps[choisiV]) { emploiDuTemps[choisiV][jour - 1] = poste; continue; } } if (estPosteCouvert(poste, jour, emploiDuTemps)) continue; let candidatsMatin = collaborateurs.filter(c => (emploiDuTempsMatin[c]?.[jour - 1] !== null && emploiDuTempsMatin[c]?.[jour - 1] !== 'REPOS') && competences[c]?.includes(poste) && (preferences[c]?.[jour] === 'travailler' || preferences[c]?.[jour] === 'indifferent' || !preferences[c]?.[jour]) && emploiDuTemps[c]?.[jour - 1] === null); if (candidatsMatin.length > 0) { const choisiMatin = choisirMoinsOccupe(candidatsMatin, emploiDuTemps); if (choisiMatin && emploiDuTemps[choisiMatin]) emploiDuTemps[choisiMatin][jour - 1] = poste; } } let jourCompletApresP1P2 = listeDesPostes.every(p => estPosteCouvert(p, jour, emploiDuTemps)); let optimisationReussie = false; if (!jourCompletApresP1P2) { console.log(`Soir - Jour ${jour}: Incomplet. Tentative optimisation (${MAX_TRIES_SOIR_OPTIMIZATION} essais)...`); for (let attempt = 0; attempt < MAX_TRIES_SOIR_OPTIMIZATION; attempt++) { const resultatOptimisation = tenterAssignationSoirOptimisation(jour, preferences, competences, emploiDuTempsMatin, listeDesPostes); if (resultatOptimisation) { for(const [collab, assign] of resultatOptimisation.entries()){ if(emploiDuTemps[collab]) emploiDuTemps[collab][jour-1] = assign; } optimisationReussie = true; console.log(`Soir Opt - Jour ${jour}: OK (essai ${attempt + 1}).`); break; } } if (!optimisationReussie) console.log(`Soir Opt - Jour ${jour}: Echec (${MAX_TRIES_SOIR_OPTIMIZATION} essais).`); } } globalEmploiDuTempsSoir = emploiDuTemps; afficherUnEmploiDuTemps(emploiDuTemps, mois, annee, nombreJours, globalPreferencesSoir, tableId, messageId, listeDesPostes); console.timeEnd("Génération EDT Soir"); return emploiDuTemps; }

    // --- AFFICHAGE EMPLOI DU TEMPS ---
    function afficherUnEmploiDuTemps(emploiDuTemps, mois, annee, nombreJours, preferences, tableId, messageId, listeDesPostes) { /* ... (inchangé) ... */ const tableauEmploiDuTemps = document.getElementById(tableId); if (!tableauEmploiDuTemps) return; const thead = tableauEmploiDuTemps.querySelector('thead tr'); const tbody = tableauEmploiDuTemps.querySelector('tbody'); if (!thead || !tbody) return; thead.innerHTML = '<th>Collaborateur</th><th>Jrs</th>'; for (let i = 1; i <= nombreJours; i++) { const th = document.createElement('th'); const jourDate = new Date(annee, mois, i); const jourSemaine = ['Di', 'Lu', 'Ma', 'Me', 'Je', 'Ve', 'Sa'][jourDate.getDay()]; th.innerHTML = `${jourSemaine}<br>${i}`; if (jourDate.getDay() === 0 || jourDate.getDay() === 6) th.classList.add('weekend'); thead.appendChild(th); } tbody.innerHTML = ''; const trVerification = document.createElement('tr'); trVerification.classList.add("verification-row"); trVerification.setAttribute('id', `verif-${tableId}`); const tdLabelVerif = document.createElement('td'); tdLabelVerif.colSpan = 2; tdLabelVerif.textContent = "Couv."; trVerification.appendChild(tdLabelVerif); for (let jour = 1; jour <= nombreJours; jour++) { const tdVerif = document.createElement('td'); const jourDate = new Date(annee, mois, jour); if (jourDate.getDay() === 0 || jourDate.getDay() === 6) tdVerif.classList.add('weekend'); trVerification.appendChild(tdVerif); } tbody.appendChild(trVerification); function updateVerificationRow() { let joursNonCouverts = 0; const row = document.getElementById(`verif-${tableId}`); if (!row) return; const edtSource = (tableId === 'tableau-emploi-du-temps') ? globalEmploiDuTempsMatin : globalEmploiDuTempsSoir; for (let jour = 1; jour <= nombreJours; jour++) { const tdVerif = row.cells[jour + 1]; if (!tdVerif) continue; const postesCouvertsCeJour = new Set(); collaborateurs.forEach(c => { if (edtSource && edtSource[c]) { const poste = edtSource[c]?.[jour - 1]; if (poste && poste !== 'REPOS') { postesCouvertsCeJour.add(poste); } } }); const tousCouverts = postesCouvertsCeJour.size === listeDesPostes.length; if (!tousCouverts) joursNonCouverts++; tdVerif.textContent = tousCouverts ? "✔" : "✘"; tdVerif.classList.remove("ok", "nok"); tdVerif.classList.add(tousCouverts ? "ok" : "nok"); tdVerif.title = tousCouverts ? "Tous couverts" : `Manquant: ${listeDesPostes.filter(l => !postesCouvertsCeJour.has(l)).join(', ') || 'Aucun!'} (${postesCouvertsCeJour.size}/${listeDesPostes.length})`; const jourDate = new Date(annee, mois, jour); if (jourDate.getDay() === 0 || jourDate.getDay() === 6) { tdVerif.classList.add('weekend'); } else { tdVerif.classList.remove('weekend'); } } const messageErreurDiv = document.getElementById(messageId); if(messageErreurDiv){ if(joursNonCouverts > 0) { const messageBase = `Attention: ${joursNonCouverts} jour(s) non couverts (✘).`; messageErreurDiv.textContent = (tableId === 'tableau-emploi-du-temps') ? messageBase + ` Algo a tenté ${MAX_TRIES_JOUR} corrections.` : messageBase + ` Assignation auto finie. ${tableId === 'tableau-emploi-du-temps-soir' ? 'Vérifiez ou éditez dans global.' : 'Vérifiez.'}`; messageErreurDiv.style.display = 'block'; } else { messageErreurDiv.style.display = 'none'; } } } updateVerificationRow(); collaborateurs.forEach(collaborateur => { const tr = document.createElement('tr'); const tdNom = document.createElement('td'); tdNom.textContent = collaborateur; tr.appendChild(tdNom); const edtSource = (tableId === 'tableau-emploi-du-temps') ? globalEmploiDuTempsMatin : globalEmploiDuTempsSoir; const tdJours = document.createElement('td'); const joursTravailles = (edtSource && edtSource[collaborateur]) ? edtSource[collaborateur].filter(j => j !== null && j !== 'REPOS').length : 0; tdJours.textContent = joursTravailles; tr.appendChild(tdJours); for (let jour = 1; jour <= nombreJours; jour++) { const td = document.createElement('td'); const assignation = (edtSource && edtSource[collaborateur]) ? edtSource[collaborateur]?.[jour - 1] : null; td.dataset.collaborateur = collaborateur; td.dataset.jour = jour.toString(); td.setAttribute('id', `cell-${tableId}-${collaborateur}-${jour}`); const prefsCollabJour = (preferences && preferences[collaborateur]) ? preferences[collaborateur][jour] : 'indifferent'; styleCell(td, assignation, prefsCollabJour); const jourDate = new Date(annee, mois, jour); if (jourDate.getDay() === 0 || jourDate.getDay() === 6) { td.classList.add('weekend'); } tr.appendChild(td); } tbody.appendChild(tr); }); tableauEmploiDuTemps.updateVerification = updateVerificationRow; }
    function styleCell(tdElement, assignation, preferenceJour) { /* ... (inchangé) ... */ const isWeekend = tdElement.classList.contains('weekend'); const dataset = { ...tdElement.dataset }; tdElement.className = ''; if (isWeekend) tdElement.classList.add('weekend'); Object.assign(tdElement.dataset, dataset); tdElement.innerHTML = ''; const collab = tdElement.dataset.collaborateur; if (assignation && assignation !== 'REPOS') { tdElement.textContent = assignation; tdElement.classList.add("Liste-assigne"); tdElement.title = `${collab} - ${assignation}`; } else if (assignation === 'REPOS') { tdElement.textContent = 'X'; tdElement.classList.add('repos'); tdElement.title = `${collab} - Repos demandé`; } else { tdElement.innerHTML = '&nbsp;'; tdElement.title = `${collab} - Libre`; if(preferenceJour === 'travailler') { tdElement.title += ` (Demandait V)`;} else if(preferenceJour === 'repos') {tdElement.title += ` (Demandait X)`;} } }

    // --- MAJ VÉRIFICATION & Cellules DÉTAILLÉES ---
    function mettreAJourVerificationSoir() { /* ... (inchangé) ... */ const tableauSoir = document.getElementById('tableau-emploi-du-temps-soir'); if (tableauSoir && typeof tableauSoir.updateVerification === 'function') { tableauSoir.updateVerification(); } const tableauCombine = document.getElementById('tableau-combiné'); if (tableauCombine && typeof tableauCombine.updateVerificationSoir === 'function') { tableauCombine.updateVerificationSoir(); } }
    function mettreAJourVerificationMatin() { /* ... (inchangé) ... */ const tableauMatin = document.getElementById('tableau-emploi-du-temps'); if (tableauMatin && typeof tableauMatin.updateVerification === 'function') { tableauMatin.updateVerification(); } const tableauCombine = document.getElementById('tableau-combiné'); if (tableauCombine && typeof tableauCombine.updateVerificationMatin === 'function') { tableauCombine.updateVerificationMatin(); } }
    function updateDetailCellMatin(collaborateur, jour, nouvelleValeur) { /* ... (inchangé) ... */ const cellId = `cell-tableau-emploi-du-temps-${collaborateur}-${jour}`; const td = document.getElementById(cellId); if (td) { styleCell(td, nouvelleValeur, null); } else { console.warn(`Detail cell Matin not found: ${cellId}`); } }
    function updateDetailCellSoir(collaborateur, jour, nouvelleValeur) { /* ... (inchangé) ... */ const cellId = `cell-tableau-emploi-du-temps-soir-${collaborateur}-${jour}`; const td = document.getElementById(cellId); if (td) { const pref = globalPreferencesSoir[collaborateur]?.[parseInt(jour, 10)]; styleCell(td, nouvelleValeur, pref); } else { console.warn(`Detail cell Soir not found: ${cellId}`); } }

    // --- Gestion Clic Cellule (Planning Combiné Global) ---
    function handleSoirCellClick(event) { /* ... (inchangé) ... */ if (draggedElement || event.target.closest('.assign-matin, .assign-soir')) { return; } const td = event.currentTarget; const collaborateur = td.dataset.collaborateur; const jour = parseInt(td.dataset.jour, 10); const valeurActuelleSoir = globalEmploiDuTempsSoir[collaborateur]?.[jour - 1] || ''; const aidePostes = aptitudesSoir.join(', '); const promptText = `Modifier affectation SOIR pour ${collaborateur} le Jour ${jour}:\nEntrez un poste (${aidePostes}), 'X' pour Repos, ou vide pour effacer.`; const nouvelleValeurRaw = prompt(promptText, valeurActuelleSoir === 'REPOS' ? 'X' : valeurActuelleSoir); if (nouvelleValeurRaw === null) return; const nouvelleValeurNettoyee = nouvelleValeurRaw.trim(); let nouvelleAffectationSoir = null; if (nouvelleValeurNettoyee.toUpperCase() === 'X') { nouvelleAffectationSoir = 'REPOS'; } else if (nouvelleValeurNettoyee === '') { nouvelleAffectationSoir = null; } else { const posteValide = aptitudesSoir.find(p => p.toLowerCase() === nouvelleValeurNettoyee.toLowerCase()); if (posteValide) { nouvelleAffectationSoir = posteValide; } else { alert(`Affectation invalide : "${nouvelleValeurRaw}".\nValides : ${aidePostes}, X, ou vide.`); return; } } if (globalEmploiDuTempsSoir && globalEmploiDuTempsSoir[collaborateur]) { globalEmploiDuTempsSoir[collaborateur][jour - 1] = nouvelleAffectationSoir; } else { console.warn(`Collab ${collaborateur} non trouvé dans global EDT Soir (clic).`); } const assignMatin = globalEmploiDuTempsMatin[collaborateur]?.[jour - 1]; updateCombinedCell(td, assignMatin, nouvelleAffectationSoir); mettreAJourVerificationSoir(); updateDetailCellSoir(collaborateur, jour.toString(), nouvelleAffectationSoir); sauvegarderEDTActuel(); cacherMessageInfoChargement(); }

    // --- Tableau Combiné Global ---
    function genererTableauCombine(edtMatin, edtSoir, mois, annee) { /* ... (inchangé) ... */ const tableId = 'tableau-combiné'; const tableauCombine = document.getElementById(tableId); if (!tableauCombine) return; const thead = tableauCombine.querySelector('thead tr'); const tbody = tableauCombine.querySelector('tbody'); if (!thead || !tbody) return; const nombreJours = new Date(annee, mois + 1, 0).getDate(); thead.innerHTML = '<th>Collaborateur</th>'; for (let i = 1; i <= nombreJours; i++) { const th = document.createElement('th'); const jourDate = new Date(annee, mois, i); const jourSemaine = ['Di', 'Lu', 'Ma', 'Me', 'Je', 'Ve', 'Sa'][jourDate.getDay()]; th.innerHTML = `${jourSemaine}<br>${i}`; if (jourDate.getDay() === 0 || jourDate.getDay() === 6) th.classList.add('weekend'); thead.appendChild(th); } tbody.innerHTML = ''; tableauCombine.updateVerificationMatin = updateVerifCombineMatin; tableauCombine.updateVerificationSoir = updateVerifCombineSoir; const trVerifMatin = document.createElement('tr'); trVerifMatin.classList.add("verification-row", "verif-matin"); trVerifMatin.setAttribute('id', 'verif-comb-matin'); const tdLabelVerifMatin = document.createElement('td'); tdLabelVerifMatin.textContent = "Couv. Matin"; trVerifMatin.appendChild(tdLabelVerifMatin); for (let jour = 1; jour <= nombreJours; jour++) { const tdVerif = document.createElement('td'); if (new Date(annee, mois, jour).getDay() % 6 === 0) tdVerif.classList.add('weekend'); trVerifMatin.appendChild(tdVerif); } tbody.appendChild(trVerifMatin); function updateVerifCombineMatin() { let joursNonCouverts = 0; const row = document.getElementById('verif-comb-matin'); if (!row) return; for (let jour = 1; jour <= nombreJours; jour++) { const tdVerif = row.cells[jour]; if (!tdVerif) continue; const postesCouvertsCeJour = new Set(); collaborateurs.forEach(c => { if (globalEmploiDuTempsMatin && globalEmploiDuTempsMatin[c]) { const poste = globalEmploiDuTempsMatin[c]?.[jour - 1]; if (poste && poste !== 'REPOS') postesCouvertsCeJour.add(poste); } }); const tousCouverts = postesCouvertsCeJour.size === listesMatin.length; if (!tousCouverts) joursNonCouverts++; tdVerif.textContent = tousCouverts ? "✔" : "✘"; tdVerif.classList.remove("ok", "nok"); tdVerif.classList.add(tousCouverts ? "ok" : "nok"); tdVerif.title = tousCouverts ? "Matin OK" : `Matin Manquant: ${listesMatin.filter(l => !postesCouvertsCeJour.has(l)).join(', ')}`; if (new Date(annee, mois, jour).getDay() % 6 === 0) tdVerif.classList.add('weekend'); else tdVerif.classList.remove('weekend'); } } updateVerifCombineMatin(); const trVerifSoir = document.createElement('tr'); trVerifSoir.classList.add("verification-row", "verif-soir"); trVerifSoir.setAttribute('id', 'verif-comb-soir'); const tdLabelVerifSoir = document.createElement('td'); tdLabelVerifSoir.textContent = "Couv. Soir"; trVerifSoir.appendChild(tdLabelVerifSoir); for (let jour = 1; jour <= nombreJours; jour++) { const tdVerif = document.createElement('td'); if (new Date(annee, mois, jour).getDay() % 6 === 0) tdVerif.classList.add('weekend'); trVerifSoir.appendChild(tdVerif); } tbody.appendChild(trVerifSoir); function updateVerifCombineSoir() { let joursNonCouverts = 0; const row = document.getElementById('verif-comb-soir'); if (!row) return; for (let jour = 1; jour <= nombreJours; jour++) { const tdVerif = row.cells[jour]; if (!tdVerif) continue; const postesCouvertsCeJour = new Set(); collaborateurs.forEach(c => { if (globalEmploiDuTempsSoir && globalEmploiDuTempsSoir[c]) { const poste = globalEmploiDuTempsSoir[c]?.[jour - 1]; if (poste && poste !== 'REPOS') postesCouvertsCeJour.add(poste); } }); const tousCouverts = postesCouvertsCeJour.size === aptitudesSoir.length; if (!tousCouverts) joursNonCouverts++; tdVerif.textContent = tousCouverts ? "✔" : "✘"; tdVerif.classList.remove("ok", "nok"); tdVerif.classList.add(tousCouverts ? "ok" : "nok"); tdVerif.title = tousCouverts ? "Soir OK" : `Soir Manquant: ${aptitudesSoir.filter(l => !postesCouvertsCeJour.has(l)).join(', ')}`; if (new Date(annee, mois, jour).getDay() % 6 === 0) tdVerif.classList.add('weekend'); else tdVerif.classList.remove('weekend'); } } updateVerifCombineSoir(); collaborateurs.forEach(collaborateur => { const tr = document.createElement('tr'); const tdNom = document.createElement('td'); tdNom.textContent = collaborateur; tr.appendChild(tdNom); for (let jour = 1; jour <= nombreJours; jour++) { const td = document.createElement('td'); td.setAttribute('id', `cell-comb-${collaborateur}-${jour}`); td.dataset.collaborateur = collaborateur; td.dataset.jour = jour.toString(); const assignMatin = globalEmploiDuTempsMatin[collaborateur]?.[jour - 1]; const assignSoir = globalEmploiDuTempsSoir[collaborateur]?.[jour - 1]; updateCombinedCell(td, assignMatin, assignSoir); const jourDate = new Date(annee, mois, jour); if (jourDate.getDay() === 0 || jourDate.getDay() === 6) { td.classList.add('weekend'); } td.classList.add('editable'); td.ondblclick = handleSoirCellClick; td.addEventListener('dragover', handleDragOver); td.addEventListener('dragleave', handleDragLeave); td.addEventListener('drop', handleDrop); tr.appendChild(td); } tbody.appendChild(tr); }); }
    function updateCombinedCell(tdElement, assignMatin, assignSoir) { /* ... (inchangé) ... */ let title = `${tdElement.dataset.collaborateur} - Jour ${tdElement.dataset.jour}:\n`; let hasContent = false; tdElement.innerHTML = ''; const addDraggableDiv = (type, value) => { const div = document.createElement('div'); div.classList.add(type === 'matin' ? 'assign-matin' : 'assign-soir'); div.textContent = value; div.draggable = true; div.addEventListener('dragstart', handleDragStart); div.addEventListener('dragend', handleDragEnd); tdElement.appendChild(div); title += `${type === 'matin' ? 'Matin' : 'Soir'}: ${value}\n`; hasContent = true; }; const addReposSpan = (explicitText = "X") => { const span = document.createElement('span'); span.classList.add('repos'); span.textContent = explicitText; tdElement.appendChild(span); hasContent = true; }; const reposMatin = (assignMatin === 'REPOS'); const reposSoir = (assignSoir === 'REPOS'); const workMatin = assignMatin && !reposMatin; const workSoir = assignSoir && !reposSoir; if (reposMatin && reposSoir) { addReposSpan(); title += "Matin: REPOS\nSoir: REPOS"; } else { if (workMatin) { addDraggableDiv('matin', assignMatin); } else if (reposMatin) { addReposSpan("X"); title += "Matin: REPOS\n"; } else { title += "Matin: Libre\n"; } if (workSoir) { addDraggableDiv('soir', assignSoir); } else if (reposSoir) { addReposSpan("X"); title += "Soir: REPOS"; } else { title += "Soir: Libre"; } } if (!hasContent) { tdElement.innerHTML = '&nbsp;'; } tdElement.title = title.trim(); }

    // --- D&D Fonctions ---
    let draggedElement = null;
    function handleDragStart(event) { /* ... (inchangé) ... */ if (event.target.tagName === 'BUTTON' || (!event.target.classList.contains('assign-matin') && !event.target.classList.contains('assign-soir'))) { event.preventDefault(); return; } draggedElement = event.target; const tdSource = draggedElement.closest('td'); if (!tdSource) return; const sourceCollab = tdSource.dataset.collaborateur; const sourceJour = tdSource.dataset.jour; const type = draggedElement.classList.contains('assign-matin') ? 'matin' : 'soir'; const value = draggedElement.textContent; const dataPayload = JSON.stringify({ sourceCollab, type, value, sourceJour }); try { event.dataTransfer.setData('text/plain', sourceJour); event.dataTransfer.setData('application/json', dataPayload); event.dataTransfer.effectAllowed = 'move'; setTimeout(() => { if (draggedElement) draggedElement.classList.add('dragging'); }, 0); console.log(`Drag Start: ${type} ${value} from ${sourceCollab} on day ${sourceJour}`); } catch (e) { console.error("Error in handleDragStart setData:", e); } }
    function handleDragEnd(event) { /* ... (inchangé) ... */ if (draggedElement) { draggedElement.classList.remove('dragging'); } document.querySelectorAll('#tableau-combiné td.drop-allowed').forEach(td => { td.classList.remove('drop-allowed'); }); draggedElement = null; }
    function handleDragOver(event) { /* ... (inchangé) ... */ event.preventDefault(); event.dataTransfer.dropEffect = 'move'; const targetTd = event.currentTarget; const sourceTd = draggedElement?.closest('td'); if (targetTd.classList.contains('editable') && targetTd !== sourceTd) { targetTd.classList.add('drop-allowed'); } else { targetTd.classList.remove('drop-allowed'); } }
    function handleDragLeave(event) { /* ... (inchangé) ... */ event.currentTarget.classList.remove('drop-allowed'); }
    function handleDrop(event) { /* ... (inchangé) ... */ event.preventDefault(); const targetTd = event.currentTarget; targetTd.classList.remove('drop-allowed'); if (!draggedElement) { return; } if (!targetTd.classList.contains('editable')) { return; } const targetCollab = targetTd.dataset.collaborateur; const targetJour = targetTd.dataset.jour; const dataPayloadString = event.dataTransfer.getData('application/json'); let payload; try { payload = JSON.parse(dataPayloadString); } catch (e) { console.error("Drop parse error:", e); return; } if (!payload || !payload.sourceCollab || !payload.type || payload.value === undefined || !payload.sourceJour) { console.error("Drop invalid or incomplete payload:", payload); return; } const { sourceCollab, type, value, sourceJour } = payload; if (sourceCollab === targetCollab && sourceJour === targetJour) { console.log("Drop on same cell ignored."); return; } const edtObject = (type === 'matin') ? globalEmploiDuTempsMatin : globalEmploiDuTempsSoir; const jourIndexTarget = parseInt(targetJour, 10) - 1; const jourIndexSource = parseInt(sourceJour, 10) - 1; if (!globalEmploiDuTempsMatin[sourceCollab] || !globalEmploiDuTempsMatin[targetCollab] || !globalEmploiDuTempsSoir[sourceCollab] || !globalEmploiDuTempsSoir[targetCollab]) { console.error("Drop Error: Global EDT data structure missing for source or target collaborator."); alert("Erreur critique: Données de planning manquantes pour un collaborateur. Rechargez la page ou vérifiez la liste des collaborateurs."); return; } const targetExistingValue = edtObject[targetCollab]?.[jourIndexTarget]; if (targetExistingValue && targetExistingValue !== 'REPOS') { if (!confirm(`Voulez-vous remplacer "${targetExistingValue}" de ${targetCollab} (Jour ${targetJour}, ${type}) par "${value}" ?`)) { return; } } edtObject[targetCollab][jourIndexTarget] = value; edtObject[sourceCollab][jourIndexSource] = null; console.log(`Moved ${type} ${value} from ${sourceCollab} Day ${sourceJour} to ${targetCollab} Day ${targetJour}`); const updatedTargetAssignMatin = globalEmploiDuTempsMatin[targetCollab]?.[jourIndexTarget]; const updatedTargetAssignSoir = globalEmploiDuTempsSoir[targetCollab]?.[jourIndexTarget]; updateCombinedCell(targetTd, updatedTargetAssignMatin, updatedTargetAssignSoir); const sourceTd = document.getElementById(`cell-comb-${sourceCollab}-${sourceJour}`); if (sourceTd) { const updatedSourceAssignMatin = globalEmploiDuTempsMatin[sourceCollab]?.[jourIndexSource]; const updatedSourceAssignSoir = globalEmploiDuTempsSoir[sourceCollab]?.[jourIndexSource]; updateCombinedCell(sourceTd, updatedSourceAssignMatin, updatedSourceAssignSoir); } else { console.warn(`Source TD not found for UI update: cell-comb-${sourceCollab}-${sourceJour}`); } if (type === 'matin') { mettreAJourVerificationMatin(); updateDetailCellMatin(sourceCollab, sourceJour, null); updateDetailCellMatin(targetCollab, targetJour, value); } else { mettreAJourVerificationSoir(); updateDetailCellSoir(sourceCollab, sourceJour, null); updateDetailCellSoir(targetCollab, targetJour, value); } sauvegarderEDTActuel(); cacherMessageInfoChargement(); }

    // --- ACTIONS PRINCIPALES ---
    function changerMois() { /* ... (inchangé) ... */ rafraichirTousLesTableauxEtEDT(); }
    function forcerRegeneration() { /* ... (inchangé) ... */ if (confirm("Regénérer les plannings ?\nCeci écrasera le planning actuel et sauvegardé.")) { console.log("Forçage regénération..."); effacerEDTSauvegardeMoisCourant(false); cacherMessageInfoChargement(); rafraichirTousLesTableauxEtEDT(true); alert("Plannings regénérés."); } }
    function exporterTableauEnPDF(tableId, suffixeNomFichier) { /* ... (inchangé) ... */ const tableauElement = document.getElementById(tableId); if (!tableauElement) { alert(`Tableau ID "${tableId}" non trouvé.`); return; } let tableWasHidden = false; let originalTableClass = tableauElement.className; const isDesiderataTable = tableId.includes('désidératats'); if (isDesiderataTable && tableauElement.classList.contains('competences-hidden')) { console.log("Dépliage temporaire colonne compétences pour PDF..."); tableWasHidden = true; tableauElement.classList.remove('competences-hidden'); tableauElement.style.display = 'none'; tableauElement.offsetHeight; tableauElement.style.display = ''; } const selectMois = document.getElementById('select-mois'); const mois = parseInt(selectMois.value); const nomMois = selectMois.options[selectMois.selectedIndex].text; const annee = anneeActuelle; const loader = document.getElementById('pdf-export-loader'); const unicornGifPath = 'https://media.giphy.com/media/e07Ym7eRkSXARDTwxc/giphy.gif?cid=790b76111f6ghj2uz5baky5i7c5x8r9xt10xzy90rcl9zsrl&ep=v1_gifs_search&rid=giphy.gif&ct=g'; if (typeof html2canvas === 'undefined' || typeof jspdf === 'undefined') { alert("Erreur : jsPDF ou html2canvas non chargé."); return; } const nomFichier = `Planning_${suffixeNomFichier}_${nomMois}_${annee}.pdf`; console.log(`Début export PDF: ${nomFichier}`); const parentSection = tableauElement.closest('.section-collapsible'); const contenuCollapsible = tableauElement.closest('.contenu-collapsible'); let sectionEtaitCachee = false; let contenuStyleOriginal = null; if (parentSection && contenuCollapsible && !parentSection.classList.contains('active')) { console.log("Section repliée, affichage temporaire..."); sectionEtaitCachee = true; contenuStyleOriginal = contenuCollapsible.style.display; parentSection.classList.add('active'); contenuCollapsible.style.display = 'block'; } document.body.classList.add('pdf-capture-mode'); if (loader) { loader.innerHTML = ''; const img = document.createElement('img'); img.src = unicornGifPath; img.alt = 'Chargement...'; const span = document.createElement('span'); span.textContent = "Export PDF en cours..."; loader.appendChild(img); loader.appendChild(span); loader.style.display = 'flex'; } html2canvas(tableauElement, { scale: 1.5, useCORS: true, allowTaint: true, backgroundColor: '#ffffff', scrollX: 0, scrollY: 0, windowWidth: tableauElement.scrollWidth, windowHeight: tableauElement.scrollHeight }).then(canvas => { try { const { jsPDF } = jspdf; const pdfWidth = 841.89; const pdfHeight = 595.28; const doc = new jsPDF('l', 'pt', 'a4'); const imgWidth = canvas.width; const imgHeight = canvas.height; const margin = 40; const availableWidth = pdfWidth - 2 * margin; const availableHeight = pdfHeight - 2 * margin; const ratio = Math.min(availableWidth / imgWidth, availableHeight / imgHeight); const finalImgWidth = imgWidth * ratio; const finalImgHeight = imgHeight * ratio; const posX = margin; const posY = margin; const imgData = canvas.toDataURL('image/png'); doc.addImage(imgData, 'PNG', posX, posY, finalImgWidth, finalImgHeight); doc.save(nomFichier); console.log("Export PDF terminé:", nomFichier); alert(`Fichier ${nomFichier} généré.`); } catch (pdfError) { console.error("Erreur PDF:", pdfError); alert("Erreur génération PDF."); } }).catch(err => { console.error("Erreur html2canvas:", err); alert("Erreur capture tableau."); }).finally(() => { if (isDesiderataTable && tableWasHidden) { console.log("Restauration état replié après PDF..."); tableauElement.className = originalTableClass; } if (sectionEtaitCachee && parentSection && contenuCollapsible) { parentSection.classList.remove('active'); contenuCollapsible.style.display = contenuStyleOriginal; } document.body.classList.remove('pdf-capture-mode'); if (loader) { loader.style.display = 'none'; loader.innerHTML = ''; } console.log("Loader caché."); }); }

    // --- FONCTIONS RESET ---
    function resetDesiderataMois(keyPrefix, nomSection) { /* ... (inchangé) ... */ if (confirm(`Effacer désidératats (${nomSection}) mois sélectionné ?`)) { const selectMois = document.getElementById('select-mois'); const mois = parseInt(selectMois.value); localStorage.removeItem(`${keyPrefix}-${mois}`); const annee = anneeActuelle; const tableId = (keyPrefix === 'désidératats') ? 'tableau-désidératats' : 'tableau-désidératats-soir'; const competencesListe = (keyPrefix === 'désidératats') ? listesMatin : aptitudesSoir; const competencesPrefix = (keyPrefix === 'désidératats') ? 'Listes' : 'Aptitudes-Soir'; genererTableauDesideratats(mois, annee, tableId, keyPrefix, competencesListe, competencesPrefix); effacerEDTSauvegardeMoisCourant(false); cacherMessageInfoChargement(); rafraichirTousLesTableauxEtEDT(true); alert(`Désidératats ${nomSection} effacés.`); fermerTousMenus(); } }
    function resetCompetencesToutes(keyPrefix, nomSection) { /* ... (inchangé) ... */ if (confirm(`Effacer toutes ${nomSection} pour TOUS les collaborateurs ?`)) { collaborateurs.forEach(c => { localStorage.removeItem(`${keyPrefix}-${c}`); }); const selectMois = document.getElementById('select-mois'); const mois = parseInt(selectMois.value); const annee = anneeActuelle; const tableId = (keyPrefix === 'Listes') ? 'tableau-désidératats' : 'tableau-désidératats-soir'; const localStorageKeyPrefixDesid = (keyPrefix === 'Listes') ? 'désidératats' : 'désidératats-soir'; const competencesListe = (keyPrefix === 'Listes') ? listesMatin : aptitudesSoir; genererTableauDesideratats(mois, annee, tableId, localStorageKeyPrefixDesid, competencesListe, keyPrefix); effacerEDTSauvegardeMoisCourant(false); cacherMessageInfoChargement(); rafraichirTousLesTableauxEtEDT(true); alert(`${nomSection} effacées.`); fermerTousMenus(); } }
    function resetComplet() { /* ... (Modifié : supprime clé thème) ... */ if (confirm("ATTENTION : Réinitialisation Complète !\nEffacer TOUS désidératats, TOUTES compétences ET TOUS plannings sauvegardés ?")) { for (let m = 0; m < 12; m++) { localStorage.removeItem(`désidératats-${m}`); localStorage.removeItem(`désidératats-soir-${m}`); localStorage.removeItem(getLocalStorageKeyEDT('matin', m, anneeActuelle)); localStorage.removeItem(getLocalStorageKeyEDT('soir', m, anneeActuelle)); } collaborateurs.forEach(c => { localStorage.removeItem(`Listes-${c}`); localStorage.removeItem(`Aptitudes-Soir-${c}`); }); localStorage.removeItem(COMPETENCES_HIDDEN_LS_KEY); localStorage.removeItem(THEME_LS_KEY); /* Supprimer thème sauvegardé */ applyTheme('rose'); /* Revenir au thème par défaut visuellement */ rafraichirTousLesTableauxEtEDT(true); alert("Réinitialisation complète."); fermerTousMenus(); } }

    // --- SAUVEGARDE/CHARGEMENT EDT ---
    function getLocalStorageKeyEDT(type, mois, annee) { /* ... (inchangé) ... */ return `edt_${type}_${annee}_${mois}`; }
    function sauvegarderEDTActuel() { /* ... (inchangé) ... */ const selectMois = document.getElementById('select-mois'); const mois = parseInt(selectMois.value); const annee = anneeActuelle; const edtMatinValide = globalEmploiDuTempsMatin && Object.keys(globalEmploiDuTempsMatin).length > 0 && collaborateurs.some(c => globalEmploiDuTempsMatin[c]); const edtSoirValide = globalEmploiDuTempsSoir && Object.keys(globalEmploiDuTempsSoir).length > 0 && collaborateurs.some(c => globalEmploiDuTempsSoir[c]); if (edtMatinValide && edtSoirValide) { try { const keyMatin = getLocalStorageKeyEDT('matin', mois, annee); const keySoir = getLocalStorageKeyEDT('soir', mois, annee); localStorage.setItem(keyMatin, JSON.stringify(globalEmploiDuTempsMatin)); localStorage.setItem(keySoir, JSON.stringify(globalEmploiDuTempsSoir)); console.log(`EDT sauvegardé: ${annee}-${mois}`); } catch (e) { console.error("Erreur sauvegarde EDT:", e); alert("Erreur sauvegarde planning."); } } else { console.warn("Tentative sauvegarde EDT vides."); } }
    function chargerEDTSauvegarde() { /* ... (inchangé) ... */ const selectMois = document.getElementById('select-mois'); const mois = parseInt(selectMois.value); const annee = anneeActuelle; const keyMatin = getLocalStorageKeyEDT('matin', mois, annee); const keySoir = getLocalStorageKeyEDT('soir', mois, annee); const dataMatin = localStorage.getItem(keyMatin); const dataSoir = localStorage.getItem(keySoir); if (dataMatin && dataSoir) { try { const parsedMatin = JSON.parse(dataMatin); const parsedSoir = JSON.parse(dataSoir); if (typeof parsedMatin === 'object' && parsedMatin !== null && Object.keys(parsedMatin).length > 0 && typeof parsedSoir === 'object' && parsedSoir !== null && Object.keys(parsedSoir).length > 0) { const collabSauvegardeMatin = Object.keys(parsedMatin); const collabSauvegardeSoir = Object.keys(parsedSoir); if (collabSauvegardeMatin.some(c => collaborateurs.includes(c)) || collabSauvegardeSoir.some(c => collaborateurs.includes(c))) { globalEmploiDuTempsMatin = parsedMatin; globalEmploiDuTempsSoir = parsedSoir; console.log(`EDT chargé: ${annee}-${mois}`); return true; } else { console.log(`Sauvegarde ${annee}-${mois} ignorée (collabs !=).`); return false; } } else { console.warn(`Données sauvegardées ${annee}-${mois} invalides.`); return false; } } catch (e) { console.error(`Erreur parsing EDT ${annee}-${mois}:`, e); return false; } } return false; }
    function effacerEDTSauvegardeMoisCourant(confirmer = true) { /* ... (inchangé) ... */ const selectMois = document.getElementById('select-mois'); const mois = parseInt(selectMois.value); const annee = anneeActuelle; const nomMois = selectMois.options[selectMois.selectedIndex].text; const keyMatin = getLocalStorageKeyEDT('matin', mois, annee); const keySoir = getLocalStorageKeyEDT('soir', mois, annee); let doitEffacer = !confirmer; if (confirmer) { if (localStorage.getItem(keyMatin) || localStorage.getItem(keySoir)) { doitEffacer = window.confirm(`Effacer planning sauvegardé ${nomMois} ${annee} ?`); } else { alert(`Aucun planning sauvegardé ${nomMois} ${annee}.`); doitEffacer = false; } } if (doitEffacer) { localStorage.removeItem(keyMatin); localStorage.removeItem(keySoir); console.log(`Sauvegarde EDT effacée ${annee}-${mois}`); globalEmploiDuTempsMatin = {}; globalEmploiDuTempsSoir = {}; globalPreferencesSoir = {}; if (confirmer) { alert(`Planning sauvegardé ${nomMois} ${annee} effacé.`); cacherMessageInfoChargement(); fermerTousMenus(); } rafraichirTousLesTableauxEtEDT(); return true; } return false; }
    function afficherMessageInfoChargement() { /* ... (inchangé) ... */ const divInfo = document.getElementById('message-info-chargement'); if (divInfo) { divInfo.textContent = "Planning chargé."; divInfo.style.display = 'block'; } }
    function cacherMessageInfoChargement() { /* ... (inchangé) ... */ const divInfo = document.getElementById('message-info-chargement'); if (divInfo) { divInfo.style.display = 'none'; } }

    // --- Fonction centrale MAJ ---
    function rafraichirTousLesTableauxEtEDT(forceRegeneration = false) { /* ... (inchangé) ... */ const selectMois = document.getElementById('select-mois'); const mois = parseInt(selectMois.value); const annee = anneeActuelle; const nomMoisAnnee = `${selectMois.options[mois].text} ${annee}`; console.log(`Rafraîchissement pour ${nomMoisAnnee}`); cacherMessageInfoChargement(); chargerCollaborateurs(); genererTableauDesideratatsMatin(mois, annee); genererTableauDesideratatsSoir(mois, annee); let edtCharge = false; if (!forceRegeneration) { edtCharge = chargerEDTSauvegarde(); } if (edtCharge) { console.log("Affichage EDT chargé."); const nombreJours = new Date(annee, mois + 1, 0).getDate(); const desideratatsSoirKey = `désidératats-soir-${mois}`; const donneesDesideratatsSoir = JSON.parse(localStorage.getItem(desideratatsSoirKey)) || {}; globalPreferencesSoir = {}; collaborateurs.forEach(c => { globalPreferencesSoir[c] = {}; for (let jour = 1; jour <= nombreJours; jour++) { const clePref = `${c}-${jour}-travail`; globalPreferencesSoir[c][jour] = donneesDesideratatsSoir[clePref] || 'indifferent'; } }); afficherUnEmploiDuTemps(globalEmploiDuTempsMatin, mois, annee, nombreJours, {}, 'tableau-emploi-du-temps', 'message-erreur-couverture', listesMatin); afficherUnEmploiDuTemps(globalEmploiDuTempsSoir, mois, annee, nombreJours, globalPreferencesSoir, 'tableau-emploi-du-temps-soir', 'message-erreur-couverture-soir', aptitudesSoir); genererTableauCombine(globalEmploiDuTempsMatin, globalEmploiDuTempsSoir, mois, annee); afficherMessageInfoChargement(); } else { console.log("Génération nouveaux EDT."); globalEmploiDuTempsMatin = {}; globalEmploiDuTempsSoir = {}; globalPreferencesSoir = {}; genererEmploiDuTempsMatin(); genererEmploiDuTempsSoir(); genererTableauCombine(globalEmploiDuTempsMatin, globalEmploiDuTempsSoir, mois, annee); sauvegarderEDTActuel(); } }

    // --- IMPORT CSV ---
    function importerDesideratas(typePeriode) { /* ... (inchangé) ... */ console.log(`--- Début Import ${typePeriode} ---`); const inputId = `upload-desiderata-${typePeriode}`; const fileInput = document.getElementById(inputId); const localStorageKeyPrefix = (typePeriode === 'matin') ? 'désidératats' : 'désidératats-soir'; const tableId = (typePeriode === 'matin') ? 'tableau-désidératats' : 'tableau-désidératats-soir'; if (!fileInput || fileInput.files.length === 0) { alert("Sélectionnez fichier CSV."); return; } const file = fileInput.files[0]; const reader = new FileReader(); reader.onload = function(event) { const fileContent = event.target.result; const lignes = fileContent.split(/\r?\n/); let nomCollaborateur = ''; const desideratasImportes = {}; let erreurs = []; let mois, annee, nombreJoursMois; const selectMois = document.getElementById('select-mois'); if (!selectMois) { console.error("ERREUR: select#select-mois non trouvé !"); erreurs.push("Erreur config page."); } else { mois = parseInt(selectMois.value); annee = anneeActuelle; if (typeof mois === 'number' && !isNaN(mois) && annee) { try { nombreJoursMois = new Date(annee, mois + 1, 0).getDate(); } catch(e) { erreurs.push("Erreur calcul jours."); } } else { erreurs.push("Mois/Année invalide."); } } if (lignes.length < 3) { erreurs.push("Format: Moins de 3 lignes."); } else if (!nombreJoursMois) { erreurs.push("Impossible parser: nb jours inconnu."); } else { const premiereLigne = lignes[0].trim(); if (premiereLigne.toLowerCase().startsWith('collaborateur:')) { nomCollaborateur = premiereLigne.substring('collaborateur:'.length).trim(); if (!collaborateurs || !collaborateurs.includes(nomCollaborateur)) { erreurs.push(`Collab "${nomCollaborateur}" inconnu.`); } } else { erreurs.push("Format L1: (Collaborateur: Nom)."); } const header = lignes[1].trim().toLowerCase(); if (header !== 'jour,statut') { console.warn(`Header CSV inattendu: "${lignes[1].trim()}"`); } for (let i = 2; i < lignes.length; i++) { const ligne = lignes[i].trim(); if (ligne === '') continue; const parts = ligne.split(','); if (parts.length !== 2) { erreurs.push(`L${i + 1}: Format incorrect.`); continue; } const jourStr = parts[0].trim(); const statutStr = parts[1].trim().toUpperCase(); const jour = parseInt(jourStr, 10); if (isNaN(jour) || jour < 1 || jour > nombreJoursMois) { erreurs.push(`L${i + 1}: Jour ${jourStr} invalide.`); continue; } let statutFinal; if (statutStr === 'V') { statutFinal = 'travailler'; } else if (statutStr === 'X') { statutFinal = 'repos'; } else if (statutStr === '?') { statutFinal = 'indifferent'; } else { erreurs.push(`L${i + 1}: Statut ${parts[1].trim()} invalide.`); continue; } desideratasImportes[jour] = statutFinal; } } const erreursBloquantes = erreurs.filter(e => e.includes("inconnu") || e.includes("incorrecte") || e.includes("Impossible") || e.includes("invalide") || e.includes("Erreur")); if (nomCollaborateur && typeof mois === 'number' && nombreJoursMois && erreursBloquantes.length === 0) { const avertissements = erreurs.filter(e => !erreursBloquantes.includes(e)); if (avertissements.length > 0) { alert("Import avec avertissements :\n" + avertissements.join("\n")); } try { const localStorageKey = `${localStorageKeyPrefix}-${mois}`; let donneesActuelles = JSON.parse(localStorage.getItem(localStorageKey)) || {}; let changements = 0; for (let jour = 1; jour <= nombreJoursMois; jour++) { const cleTravail = `${nomCollaborateur}-${jour}-travail`; if (desideratasImportes.hasOwnProperty(jour)) { const statutImporte = desideratasImportes[jour]; if (statutImporte === 'indifferent') { if (donneesActuelles[cleTravail]) { delete donneesActuelles[cleTravail]; changements++; } } else { if (donneesActuelles[cleTravail] !== statutImporte) { donneesActuelles[cleTravail] = statutImporte; changements++; } } } } if (changements > 0 || (Object.keys(donneesActuelles).length > 0 && Object.keys(desideratasImportes).length === 0)) { localStorage.setItem(localStorageKey, JSON.stringify(donneesActuelles)); } if (Object.keys(donneesActuelles).length === 0) { localStorage.removeItem(localStorageKey); } } catch (lsError) { alert("Erreur sauvegarde préférences."); } const tableau = document.getElementById(tableId); if (tableau) { const tbody = tableau.querySelector('tbody'); const rows = tbody.querySelectorAll('tr'); let ligneTrouveeUI = false; for (const tr of rows) { const tdNomCell = tr.querySelector('td:nth-child(2)'); const spanNom = tdNomCell ? tdNomCell.querySelector('span:not(.button-group-desiderata)') : null; if (spanNom && spanNom.textContent.trim() === nomCollaborateur) { ligneTrouveeUI = true; const selects = tr.querySelectorAll('td:nth-child(n+3) select'); selects.forEach((select, index) => { const jour = index + 1; const statut = desideratasImportes[jour] || 'indifferent'; if (select.value !== statut) { select.value = statut; mettreAJourCouleurSelect(select); } else { mettreAJourCouleurSelect(select); } }); break; } } } if (typeof effacerEDTSauvegardeMoisCourant === 'function') { effacerEDTSauvegardeMoisCourant(false); } if (typeof cacherMessageInfoChargement === 'function') { cacherMessageInfoChargement(); } alert(`Désidératats ${typePeriode} pour ${nomCollaborateur} importés !`); } else { alert("Échec importation :\n" + (erreursBloquantes.length > 0 ? erreursBloquantes.join("\n") : "Erreur inconnue.")); } if(fileInput) fileInput.value = ''; }; reader.onerror = function() { alert("Erreur lecture fichier."); if(fileInput) fileInput.value = ''; }; reader.readAsText(file); }

    // --- GESTION SECTIONS REPLIABLES ---
    function setupCollapsibleSections() { /* ... (inchangé) ... */ const triggers = document.querySelectorAll('.collapsible-trigger'); triggers.forEach(trigger => { const parentSection = trigger.closest('.section-collapsible'); const content = parentSection ? parentSection.querySelector('.contenu-collapsible') : null; if (!parentSection || !content) return; const isActive = parentSection.classList.contains('active'); let initialText = trigger.textContent.replace(/[\u25BC\u25B2▾▴▼▲▶]/g, '').trim(); trigger.innerHTML = `${initialText} <span class="arrow">${isActive ? '&#x25B2;' : '&#x25BC;'}</span>`; content.style.display = isActive ? 'block' : 'none'; trigger.addEventListener('click', function() { const section = this.closest('.section-collapsible'); if (!section) return; const cont = section.querySelector('.contenu-collapsible'); if (!cont) return; const arrowSpan = this.querySelector('.arrow'); section.classList.toggle('active'); const isOpen = section.classList.contains('active'); if (arrowSpan) arrowSpan.innerHTML = isOpen ? '&#x25B2;' : '&#x25BC;'; cont.style.display = isOpen ? 'block' : 'none'; }); }); }

// --- INITIALISATION PAGE ---
document.addEventListener('DOMContentLoaded', () => {
        // Déterminer le mois et l'année à afficher initialement
        const maintenant = new Date();
        let anneePourAffichage = maintenant.getFullYear();
        let moisPourAffichage = maintenant.getMonth() + 1; // Index du mois actuel + 1

        // Gérer le passage de Décembre à Janvier
        if (moisPourAffichage > 11) { // Si on obtient 12 (après Décembre qui est 11)
            moisPourAffichage = 0; // Le mois devient Janvier (index 0)
            anneePourAffichage++; // On incrémente l'année
        }

        // Mettre à jour la variable globale anneeActuelle pour que les fonctions suivantes
        // utilisent la bonne année, surtout si on a changé d'année.
        anneeActuelle = anneePourAffichage;

        loadSavedTheme(); // Charger le thème préféré
        chargerCollaborateurs();

        const selectMois = document.getElementById('select-mois');
        if (selectMois) {
            // Définir la valeur du select sur le mois SUIVANT calculé
            selectMois.value = moisPourAffichage;
        }

        // Rafraîchir les tableaux. Cette fonction utilisera la valeur
        // maintenant sélectionnée dans selectMois et la variable anneeActuelle mise à jour.
        rafraichirTousLesTableauxEtEDT();
        setupCollapsibleSections();

        // Gestion overlay menus (inchangé)
        const overlay = document.getElementById('overlay-menus');
        if (overlay) overlay.addEventListener('click', fermerTousMenus);
        window.addEventListener('click', function(event) {
            const isClickInsideMenu = event.target.closest('.menu-content');
            const isClickOnToggler = event.target.closest('.menu-btn') || event.target.closest('.menu-reset-btn');
            const isOverlayVisible = document.getElementById('overlay-menus')?.classList.contains('show');
            if (isOverlayVisible && !isClickInsideMenu && !isClickOnToggler) {
                fermerTousMenus();
            }
        });
    });

    // --- PWA Service Worker ---
    if ('serviceWorker' in navigator) { window.addEventListener('load', () => { navigator.serviceWorker.register('./sw.js').then(reg => console.log('SW enregistré:', reg.scope)).catch(err => console.error('Erreur SW:', err)); }); } else { console.log('Service Worker non supporté.'); }

</script>
</body>
</html>